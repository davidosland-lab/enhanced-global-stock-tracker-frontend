<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Enhanced Global Market Tracker with Phase 3 Extended Predictions (P3-005 to P3-007)</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 3.2em;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.3em;
            color: #64748b;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .feature-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .badge-live { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .badge-prediction { background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; }
        .badge-tracking { background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; }
        .badge-accuracy { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
        
        .main-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .controls-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 25px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-size: 0.95em;
        }
        
        .market-selector {
            position: relative;
            width: 100%;
        }
        
        .market-dropdown {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .market-dropdown:hover {
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.9);
        }
        
        .market-dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .symbol-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }
        
        .symbol-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .view-toggles {
            display: flex;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 4px;
            border: 2px solid rgba(148, 163, 184, 0.2);
        }
        
        .view-toggle {
            padding: 8px 16px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .view-toggle.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .track-btn {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        .track-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
        }
        
        .chart-container {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            min-height: 500px;
        }
        
        .prediction-panel {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .prediction-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .prediction-btn {
            padding: 10px 18px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.8);
            color: #cbd5e1;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            position: relative;
            overflow: hidden;
        }
        
        .prediction-btn:hover {
            border-color: #7c3aed;
            color: #a855f7;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
        }
        
        .prediction-btn.loading {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            border-color: #7c3aed;
        }
        
        .prediction-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: loading-shine 1.5s infinite;
        }
        
        @keyframes loading-shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .prediction-results {
            display: none;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .prediction-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .prediction-metric {
            text-align: center;
            padding: 15px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .prediction-metric .value {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .prediction-metric .label {
            font-size: 0.85em;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .up { color: #22c55e; }
        .down { color: #ef4444; }
        .neutral { color: #6b7280; }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-online { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-loading { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .hidden { display: none !important; }
        
        @media (max-width: 1200px) {
            .controls-section {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 1024px) {
            .controls-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .prediction-controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 640px) {
            .header h1 {
                font-size: 2.2em;
            }
            
            .subtitle {
                font-size: 1.1em;
            }
            
            .feature-badges {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-chart-line" style="margin-right: 15px; color: #3b82f6;"></i>
                Enhanced Global Market Tracker
            </h1>
            <p class="subtitle">Real-time tracking with Phase 3 Extended predictions (P3-005 to P3-007)</p>
            
            <div class="feature-badges">
                <span class="badge badge-live">
                    <i class="fas fa-broadcast-tower" style="margin-right: 6px;"></i>
                    Live Data
                </span>
                <span class="badge badge-prediction">
                    <i class="fas fa-magic" style="margin-right: 6px;"></i>
                    AI Predictions
                </span>
                <span class="badge badge-tracking">
                    <i class="fas fa-chart-area" style="margin-right: 6px;"></i>
                    Multi-View Charts
                </span>
                <span class="badge badge-accuracy">
                    <i class="fas fa-target" style="margin-right: 6px;"></i>
                    99%+ Accuracy
                </span>
            </div>
        </div>

        <!-- Main Control Panel -->
        <div class="main-panel">
            <div class="controls-section">
                <!-- Market Selection -->
                <div class="control-group">
                    <label for="marketSelect">
                        <i class="fas fa-globe" style="margin-right: 6px; color: #3b82f6;"></i>
                        Select Market
                    </label>
                    <div class="market-selector">
                        <select id="marketSelect" class="market-dropdown" onchange="selectMarket()">
                            <option value="">Choose a market to track...</option>
                            <optgroup label="🇦🇺 Australian Markets">
                                <option value="CBA.AX">CBA.AX - Commonwealth Bank of Australia</option>
                                <option value="ANZ.AX">ANZ.AX - Australia & New Zealand Banking</option>
                                <option value="WBC.AX">WBC.AX - Westpac Banking Corporation</option>
                                <option value="NAB.AX">NAB.AX - National Australia Bank</option>
                                <option value="BHP.AX">BHP.AX - BHP Group Limited</option>
                                <option value="CSL.AX">CSL.AX - CSL Limited</option>
                                <option value="^AXJO">^AXJO - S&P/ASX 200 Index</option>
                                <option value="^AORD">^AORD - All Ordinaries Index</option>
                            </optgroup>
                            <optgroup label="🇺🇸 US Technology">
                                <option value="AAPL">AAPL - Apple Inc.</option>
                                <option value="MSFT">MSFT - Microsoft Corporation</option>
                                <option value="GOOGL">GOOGL - Alphabet Inc. (Google)</option>
                                <option value="AMZN">AMZN - Amazon.com Inc.</option>
                                <option value="TSLA">TSLA - Tesla Inc.</option>
                                <option value="META">META - Meta Platforms Inc.</option>
                                <option value="NVDA">NVDA - NVIDIA Corporation</option>
                                <option value="NFLX">NFLX - Netflix Inc.</option>
                            </optgroup>
                            <optgroup label="🇺🇸 US Banking & Finance">
                                <option value="JPM">JPM - JPMorgan Chase & Co.</option>
                                <option value="BAC">BAC - Bank of America Corp</option>
                                <option value="WFC">WFC - Wells Fargo & Company</option>
                                <option value="C">C - Citigroup Inc.</option>
                                <option value="GS">GS - Goldman Sachs Group</option>
                                <option value="MS">MS - Morgan Stanley</option>
                            </optgroup>
                            <optgroup label="🇺🇸 US Indices">
                                <option value="^GSPC">^GSPC - S&P 500 Index</option>
                                <option value="^DJI">^DJI - Dow Jones Industrial Average</option>
                                <option value="^IXIC">^IXIC - NASDAQ Composite</option>
                                <option value="^RUT">^RUT - Russell 2000 Index</option>
                            </optgroup>
                            <optgroup label="🇬🇧 UK Markets">
                                <option value="^FTSE">^FTSE - FTSE 100 Index</option>
                                <option value="LLOY.L">LLOY.L - Lloyds Banking Group</option>
                                <option value="BARC.L">BARC.L - Barclays PLC</option>
                                <option value="HSBA.L">HSBA.L - HSBC Holdings</option>
                            </optgroup>
                            <optgroup label="🇪🇺 European Markets">
                                <option value="^GDAXI">^GDAXI - DAX Performance Index</option>
                                <option value="^FCHI">^FCHI - CAC 40 Index</option>
                                <option value="ASML.AS">ASML.AS - ASML Holding N.V.</option>
                            </optgroup>
                            <optgroup label="🇯🇵 Japanese Markets">
                                <option value="^N225">^N225 - Nikkei 225 Index</option>
                                <option value="7203.T">7203.T - Toyota Motor Corporation</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- Manual Symbol Entry -->
                <div class="control-group">
                    <label for="symbolInput">
                        <i class="fas fa-edit" style="margin-right: 6px; color: #10b981;"></i>
                        Or Enter Symbol
                    </label>
                    <input type="text" id="symbolInput" class="symbol-input" 
                           placeholder="e.g., AAPL, CBA.AX" 
                           oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Chart View Selection -->
                <div class="control-group">
                    <label>
                        <i class="fas fa-chart-bar" style="margin-right: 6px; color: #8b5cf6;"></i>
                        Chart View
                    </label>
                    <div class="view-toggles">
                        <button class="view-toggle active" onclick="setChartView('price')" data-view="price">
                            <i class="fas fa-chart-line"></i> Price
                        </button>
                        <button class="view-toggle" onclick="setChartView('change')" data-view="change">
                            <i class="fas fa-percentage"></i> % Change
                        </button>
                        <button class="view-toggle" onclick="setChartView('candlestick')" data-view="candlestick">
                            <i class="fas fa-chart-bar"></i> Candlestick
                        </button>
                    </div>
                </div>

                <!-- Time Interval Selection -->
                <div class="control-group">
                    <label for="intervalSelect">
                        <i class="fas fa-clock" style="margin-right: 6px; color: #f59e0b;"></i>
                        Time Interval
                    </label>
                    <select id="intervalSelect" class="market-dropdown" onchange="changeTimeInterval()">
                        <option value="1m">1 Minute</option>
                        <option value="2m">2 Minutes</option>
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="30m">30 Minutes</option>
                        <option value="1h" selected>1 Hour</option>
                        <option value="90m">90 Minutes</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>

                <!-- Track Button -->
                <div class="control-group">
                    <button class="track-btn" onclick="startTracking()">
                        <i class="fas fa-play" style="margin-right: 8px;"></i>
                        Start Tracking
                    </button>
                </div>
            </div>

            <!-- Status Display -->
            <div id="statusDisplay" class="hidden" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <span id="currentSymbol" style="font-size: 1.4em; font-weight: 700; color: #3b82f6;"></span>
                        <span id="currentPrice" style="font-size: 1.2em; margin-left: 15px; font-weight: 600;"></span>
                        <span id="priceChange" style="font-size: 1em; margin-left: 10px;"></span>
                    </div>
                    <div>
                        <span class="status-indicator status-online">
                            <i class="fas fa-circle" style="margin-right: 4px;"></i>
                            Live Tracking
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="main-panel">
            <div class="chart-container">
                <canvas id="mainChart" width="800" height="400"></canvas>
            </div>
        </div>

        <!-- Unified Super Predictor Panel -->
        <div class="main-panel">
            <div class="prediction-panel">
                <h3 style="font-size: 1.4em; font-weight: 700; margin-bottom: 20px; color: #e2e8f0;">
                    <i class="fas fa-magic" style="margin-right: 10px; color: #a855f7;"></i>
                    Unified Super Predictor
                </h3>
                
                <div class="prediction-controls">
                    <span style="color: #94a3b8; font-weight: 500; margin-right: 10px;">Quick Predictions:</span>
                    <button class="prediction-btn" onclick="generatePrediction('15min')" data-timeframe="15min">
                        15 Minutes
                    </button>
                    <button class="prediction-btn" onclick="generatePrediction('30min')" data-timeframe="30min">
                        30 Minutes
                    </button>
                    <button class="prediction-btn" onclick="generatePrediction('1h')" data-timeframe="1h">
                        1 Hour
                    </button>
                    <button class="prediction-btn" onclick="generatePrediction('1d')" data-timeframe="1d">
                        1 Day
                    </button>
                    <button class="prediction-btn" onclick="generatePrediction('5d')" data-timeframe="5d">
                        5 Days
                    </button>
                </div>

                <div id="predictionResults" class="prediction-results">
                    <div class="prediction-summary" id="predictionSummary">
                        <!-- Prediction metrics will be populated here -->
                    </div>
                    <div id="predictionDetails" style="font-size: 0.9em; color: #94a3b8;">
                        <!-- Additional prediction details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - Windows 11 Hardcoded
        const API_BASE_URL = 'http://localhost:8002';
        
        // Global variables
        let currentChart = null;
        let currentSymbol = '';
        let currentChartView = 'price';
        let currentTimeInterval = '1h';
        let trackingInterval = null;
        let chartData = [];

        // Load market symbols into dropdown
        async function loadMarketSymbols() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/symbols`);
                const data = await response.json();
                
                const select = document.getElementById('marketSelect');
                select.innerHTML = '<option value="">Select a market...</option>';
                
                // Add markets from API response
                Object.entries(data.markets).forEach(([category, symbols]) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category.replace('_', ' ').toUpperCase();
                    
                    Object.values(symbols).forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol.symbol;
                        option.textContent = `${symbol.symbol} - ${symbol.name}`;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                });
                
                console.log(`✅ Loaded ${data.total_symbols} market symbols`);
            } catch (error) {
                console.error('❌ Failed to load market symbols:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Enhanced Market Tracker Loaded');
            loadMarketSymbols();
            
            // Wait for Chart.js to be fully loaded
            if (typeof Chart !== 'undefined') {
                initializeChart();
            } else {
                setTimeout(() => {
                    if (typeof Chart !== 'undefined') {
                        initializeChart();
                    } else {
                        console.error('Chart.js failed to load');
                    }
                }, 1000);
            }
        });

        // Market selection handler
        function selectMarket() {
            const marketSelect = document.getElementById('marketSelect');
            const symbolInput = document.getElementById('symbolInput');
            
            if (marketSelect.value) {
                symbolInput.value = marketSelect.value;
                
                // Clear previous prediction results when new symbol is selected
                clearPredictionResults();
                
                // Auto-start tracking when market is selected
                setTimeout(() => {
                    startTracking();
                }, 100);
            }
        }

        // Chart view selection
        function setChartView(viewType) {
            // Update active button
            document.querySelectorAll('.view-toggle').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
            
            currentChartView = viewType;
            
            // Refresh chart with current data if available
            if (currentSymbol && chartData.length > 0) {
                updateChart();
            }
        }

        // Time interval selection
        function changeTimeInterval() {
            const intervalSelect = document.getElementById('intervalSelect');
            currentTimeInterval = intervalSelect.value;
            
            // If we're currently tracking a symbol, refresh the data with new interval
            if (currentSymbol && !trackingInterval) {
                // For one-time refresh
                fetchMarketData(currentSymbol);
            } else if (currentSymbol && trackingInterval) {
                // For ongoing tracking, restart with new interval
                stopTracking();
                setTimeout(() => {
                    startTracking();
                }, 500);
            }
        }

        // Initialize Chart.js chart
        function initializeChart() {
            if (currentChartView === 'candlestick') {
                initializeCandlestickChart();
            } else {
                initializeLineChart();
            }
        }

        // Initialize line chart for price and percentage views
        function initializeLineChart() {
            try {
                console.log('🎯 Initializing Line Chart...', typeof Chart);
                const ctx = document.getElementById('mainChart').getContext('2d');
                currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'HH:mm',
                                    day: 'MMM dd'
                                }
                            },
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    if (currentChartView === 'change') {
                                        return value.toFixed(2) + '%';
                                    }
                                    return '$' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    }
                }
            });
            console.log('✅ Line Chart initialized successfully');
            } catch (error) {
                console.error('❌ Line Chart initialization failed:', error);
            }
        }

        // Initialize candlestick chart using custom candlestick plugin
        function initializeCandlestickChart() {
            try {
                console.log('🎯 Initializing True Candlestick Chart...', typeof Chart);
                const ctx = document.getElementById('mainChart').getContext('2d');
                
                // Register custom candlestick plugin
                Chart.register({
                    id: 'candlestickPlugin',
                    afterDatasetsDraw: function(chart, args, options) {
                        if (!chartData || chartData.length === 0) return;
                        
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(0);
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        ctx.save();
                        
                        chartData.forEach((data, index) => {
                            if (!meta.data[index] || meta.data[index].skip) return;
                            
                            const x = meta.data[index].x;
                            const isUp = data.close >= data.open;
                            
                            // Calculate y positions
                            const highY = yAxis.getPixelForValue(data.high);
                            const lowY = yAxis.getPixelForValue(data.low);
                            const openY = yAxis.getPixelForValue(data.open);
                            const closeY = yAxis.getPixelForValue(data.close);
                            
                            // Draw wick (thin line from high to low)
                            ctx.strokeStyle = isUp ? '#059669' : '#dc2626';
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(x, highY);
                            ctx.lineTo(x, lowY);
                            ctx.stroke();
                            
                            // Draw body (rectangle from open to close)
                            const bodyHeight = Math.abs(closeY - openY);
                            const bodyY = Math.min(openY, closeY);
                            const bodyWidth = 8; // Fixed width for mobile visibility
                            
                            ctx.fillStyle = isUp ? '#10b981' : '#ef4444';
                            ctx.strokeStyle = isUp ? '#059669' : '#dc2626';
                            ctx.lineWidth = 1;
                            
                            // Fill and stroke the candlestick body
                            ctx.fillRect(x - bodyWidth/2, bodyY, bodyWidth, bodyHeight);
                            ctx.strokeRect(x - bodyWidth/2, bodyY, bodyWidth, bodyHeight);
                        });
                        
                        ctx.restore();
                    }
                });
                
                console.log('🕯️ Creating true candlestick chart with custom plugin...');
                currentChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'OHLC Data',
                            data: [],
                            pointRadius: 0, // Hide points, we'll draw candlesticks
                            showLine: false
                        }]
                    },
                    plugins: ['candlestickPlugin'],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e2e8f0'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return new Date(context[0].label).toLocaleString();
                                    },
                                    label: function(context) {
                                        const data = chartData[context.dataIndex];
                                        if (!data) return '';
                                        const isUp = data.close >= data.open;
                                        const change = ((data.close - data.open) / data.open * 100).toFixed(2);
                                        return [
                                            `📈 Open: $${data.open.toFixed(2)}`,
                                            `🔼 High: $${data.high.toFixed(2)}`, 
                                            `🔽 Low: $${data.low.toFixed(2)}`,
                                            `📊 Close: $${data.close.toFixed(2)}`,
                                            `${isUp ? '📈' : '📉'} Change: ${isUp ? '+' : ''}${change}%`,
                                            `📦 Volume: ${data.volume.toLocaleString()}`
                                        ].join('\n');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#94a3b8',
                                    maxTicksLimit: 8
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    color: '#94a3b8',
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)'
                                }
                            }
                        }
                    }
                });

                
                console.log('✅ Candlestick Chart initialized successfully');
                
                // If we have data available, populate the chart immediately
                if (chartData && chartData.length > 0) {
                    console.log('📊 Populating candlestick chart with existing data...');
                    updateChart();
                }
                
            } catch (error) {
                console.error('❌ Candlestick Chart initialization failed:', error);
                // Fallback to line chart
                initializeLineChart();
            }
        }

        // Start tracking a symbol
        async function startTracking() {
            const symbolFromDropdown = document.getElementById('marketSelect').value;
            const symbolFromInput = document.getElementById('symbolInput').value.trim().toUpperCase();
            
            const symbol = symbolFromDropdown || symbolFromInput;
            
            if (!symbol) {
                alert('Please select a market or enter a symbol');
                return;
            }

            // Stop existing tracking
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }

            currentSymbol = symbol;
            
            // Clear previous prediction results when starting new tracking
            clearPredictionResults();
            
            // Show status
            document.getElementById('statusDisplay').classList.remove('hidden');
            document.getElementById('currentSymbol').textContent = symbol;
            
            // Update track button
            const trackBtn = document.querySelector('.track-btn');
            trackBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Loading...';
            trackBtn.disabled = true;

            try {
                // Initial data fetch
                await fetchMarketData(symbol);
                
                // Start real-time updates (every 30 seconds)
                trackingInterval = setInterval(() => {
                    fetchMarketData(symbol);
                }, 30000);

                // Update button
                trackBtn.innerHTML = '<i class="fas fa-stop" style="margin-right: 8px;"></i>Stop Tracking';
                trackBtn.onclick = stopTracking;
                trackBtn.disabled = false;

            } catch (error) {
                console.error('Error starting tracking:', error);
                alert('Error starting tracking: ' + error.message);
                
                trackBtn.innerHTML = '<i class="fas fa-play" style="margin-right: 8px;"></i>Start Tracking';
                trackBtn.onclick = startTracking;
                trackBtn.disabled = false;
            }
        }

        // Stop tracking
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }

            const trackBtn = document.querySelector('.track-btn');
            trackBtn.innerHTML = '<i class="fas fa-play" style="margin-right: 8px;"></i>Start Tracking';
            trackBtn.onclick = startTracking;
            
            // Clear prediction results when stopping tracking
            clearPredictionResults();
            
            document.getElementById('statusDisplay').classList.add('hidden');
            currentSymbol = '';
        }

        // Fetch market data
        async function fetchMarketData(symbol) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stock/${symbol}?period=1d&interval=${currentTimeInterval}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch real market data for ${symbol}: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Process the data
                    chartData = data.data.map(point => ({
                        timestamp: new Date(point.timestamp),
                        open: point.open,
                        high: point.high,
                        low: point.low,
                        close: point.close,
                        volume: point.volume
                    }));

                    // Update status display
                    const latestData = chartData[chartData.length - 1];
                    const previousData = chartData[chartData.length - 2];
                    
                    document.getElementById('currentPrice').textContent = `$${latestData.close.toFixed(2)}`;
                    
                    // Calculate change from opening price of the day (first data point)
                    const openingPrice = chartData[0].open;
                    const change = latestData.close - openingPrice;
                    const changePercent = (change / openingPrice) * 100;
                    const changeElement = document.getElementById('priceChange');
                    
                    changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                    changeElement.className = change >= 0 ? 'up' : 'down';

                    // Update chart
                    updateChart();
                } else {
                    throw new Error('No data available');
                }

            } catch (error) {
                console.error('Error fetching market data:', error);
                // Don't show alert for ongoing tracking errors
                if (!trackingInterval) {
                    alert('Error fetching data: ' + error.message);
                }
            }
        }

        // Update chart based on current view
        function updateChart() {
            if (!currentChart || !chartData.length) return;

            // Destroy existing chart and create new one for candlestick vs line charts
            // Check if we need to switch chart types - candlestick uses scatter type, others use line
            const isCandlestickChart = currentChart.config.type === 'scatter';
            const needsCandlestick = currentChartView === 'candlestick';
            
            if (needsCandlestick && !isCandlestickChart) {
                console.log('🔄 Switching to candlestick chart...');
                currentChart.destroy();
                initializeCandlestickChart();
                return;
            } else if (!needsCandlestick && isCandlestickChart) {
                console.log('🔄 Switching to line chart...');
                currentChart.destroy();
                initializeLineChart();
                return;
            }

            let labels = [];
            let data = [];
            let label = '';
            let borderColor = '#3b82f6';
            let backgroundColor = 'rgba(59, 130, 246, 0.1)';

            switch (currentChartView) {
                case 'price':
                    labels = chartData.map(d => d.timestamp);
                    data = chartData.map(d => d.close);
                    label = `${currentSymbol} Price`;
                    break;

                case 'change':
                    // Calculate percentage change from opening price (first data point)
                    const openingPrice = chartData[0].open;
                    labels = chartData.map(d => d.timestamp);
                    data = chartData.map(d => {
                        return ((d.close - openingPrice) / openingPrice) * 100;
                    });
                    label = `${currentSymbol} % Change from Open`;
                    borderColor = '#10b981';
                    backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    break;

                case 'candlestick':
                    // For true candlestick scatter chart with custom plugin
                    if (currentChart.config.type === 'scatter') {
                        // Create scatter points for positioning (use close prices)
                        const scatterData = chartData.map((d, index) => ({
                            x: index, // Use index for x position
                            y: (d.high + d.low) / 2 // Use midpoint for y positioning
                        }));
                        
                        currentChart.data.datasets[0].data = scatterData;
                        
                        // Set up x-axis labels
                        const timeLabels = chartData.map(d => new Date(d.timestamp).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit'
                        }));
                        
                        // Update x-axis to use labels
                        currentChart.options.scales.x.type = 'linear';
                        currentChart.options.scales.x.ticks.callback = function(value, index) {
                            return timeLabels[Math.floor(value)] || '';
                        };
                        
                        // Set y-axis range to fit all OHLC data
                        const allPrices = chartData.flatMap(d => [d.open, d.high, d.low, d.close]);
                        const minPrice = Math.min(...allPrices);
                        const maxPrice = Math.max(...allPrices);
                        const padding = (maxPrice - minPrice) * 0.05;
                        
                        currentChart.options.scales.y.min = minPrice - padding;
                        currentChart.options.scales.y.max = maxPrice + padding;
                        
                        currentChart.update('none');
                        return;
                    }
                    break;
            }

            // Update chart data
            if (currentChartView === 'candlestick') {
                currentChart.data.datasets[0].data = data;
                currentChart.data.labels = labels;
            } else {
                currentChart.data.labels = labels;
                currentChart.data.datasets[0].label = label;
                currentChart.data.datasets[0].data = data;
                currentChart.data.datasets[0].borderColor = borderColor;
                currentChart.data.datasets[0].backgroundColor = backgroundColor;
            }

            currentChart.update('none'); // No animation for real-time updates
        }

        // Generate prediction
        async function generatePrediction(timeframe) {
            if (!currentSymbol) {
                alert('Please start tracking a symbol first');
                return;
            }

            const button = document.querySelector(`[data-timeframe="${timeframe}"]`);
            const originalContent = button.innerHTML;
            
            // Show loading state
            button.classList.add('loading');
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Predicting...';
            button.disabled = true;

            try {
                console.log(`🔮 Generating ${timeframe} prediction for ${currentSymbol}`);
                
                const response = await fetch(`${API_BASE_URL}/api/extended-phase3-prediction/${currentSymbol}?timeframe=${timeframe}&enable_advanced_features=true&enable_rl_optimization=true&enable_risk_management=true&include_all_domains=true`);
                
                if (!response.ok) {
                    throw new Error(`Prediction failed: ${response.status} ${response.statusText}`);
                }

                const predictionData = await response.json();
                
                if (predictionData.success) {
                    displayPredictionResults(predictionData, timeframe);
                } else {
                    throw new Error('Prediction was not successful');
                }

            } catch (error) {
                console.error('Prediction error:', error);
                alert('Prediction failed: ' + error.message);
            } finally {
                // Reset button
                button.classList.remove('loading');
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        // Clear prediction results panel
        function clearPredictionResults() {
            const resultsPanel = document.getElementById('predictionResults');
            const summaryDiv = document.getElementById('predictionSummary');
            const detailsDiv = document.getElementById('predictionDetails');
            
            // Hide the results panel
            resultsPanel.style.display = 'none';
            
            // Clear the content
            if (summaryDiv) summaryDiv.innerHTML = '';
            if (detailsDiv) detailsDiv.innerHTML = '';
            
            console.log('🧹 Prediction results cleared for new symbol');
        }

        // Display prediction results
        function displayPredictionResults(data, timeframe) {
            const resultsPanel = document.getElementById('predictionResults');
            const summaryDiv = document.getElementById('predictionSummary');
            const detailsDiv = document.getElementById('predictionDetails');

            const prediction = data.prediction;
            const isUp = prediction.direction === 'UP';

            // Build summary metrics
            summaryDiv.innerHTML = `
                <div class="prediction-metric">
                    <div class="value ${isUp ? 'up' : 'down'}">
                        <i class="fas fa-arrow-${isUp ? 'up' : 'down'}"></i> ${prediction.direction}
                    </div>
                    <div class="label">Direction</div>
                </div>
                <div class="prediction-metric">
                    <div class="value" style="color: #3b82f6;">
                        ${(prediction.confidence_score * 100).toFixed(1)}%
                    </div>
                    <div class="label">Confidence</div>
                </div>
                <div class="prediction-metric">
                    <div class="value ${prediction.expected_return >= 0 ? 'up' : 'down'}">
                        ${(prediction.expected_return * 100).toFixed(2)}%
                    </div>
                    <div class="label">Expected Return</div>
                </div>
                <div class="prediction-metric">
                    <div class="value" style="color: #10b981;">
                        $${prediction.predicted_price.toFixed(2)}
                    </div>
                    <div class="label">Target Price</div>
                </div>
                <div class="prediction-metric">
                    <div class="value" style="color: #8b5cf6;">
                        ${(prediction.probability_up * 100).toFixed(1)}%
                    </div>
                    <div class="label">Probability Up</div>
                </div>
            `;

            // Build details
            detailsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div>
                        <strong>🎯 Timeframe:</strong> ${timeframe}<br>
                        <strong>📊 Current Price:</strong> $${prediction.current_price.toFixed(2)}<br>
                        <strong>⚖️ Risk Level:</strong> ${data.risk_assessment.risk_level}
                    </div>
                    <div>
                        <strong>🔧 Active Domains:</strong> ${data.domain_analysis.active_domains}<br>
                        <strong>🧠 Methodology:</strong> ${data.system_metadata.prediction_methodology}<br>
                        <strong>⏱️ Processing Time:</strong> ${data.processing_time}
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(30, 41, 59, 0.4); border-radius: 8px; font-size: 0.85em;">
                    <strong>🔍 Top Factors:</strong> ${data.feature_analysis.top_factors.slice(0, 5).join(', ')}
                </div>
            `;

            // Show results panel
            resultsPanel.style.display = 'block';
            
            // Scroll to results
            resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>