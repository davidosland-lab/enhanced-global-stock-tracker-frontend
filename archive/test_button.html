<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Start Tracking Button</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #log {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
        .info { color: #74c0fc; }
        input, select {
            padding: 10px;
            margin: 5px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Test Start Tracking Button - Direct Implementation</h1>
    
    <div>
        <select id="marketSelect">
            <option value="">Select Market...</option>
            <option value="AAPL" selected>Apple (AAPL)</option>
            <option value="MSFT">Microsoft (MSFT)</option>
            <option value="GOOGL">Google (GOOGL)</option>
        </select>
        <input type="text" id="symbolInput" placeholder="Or enter custom symbol">
        <button id="startBtn" onclick="testStartTracking()">Start Tracking</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="statusDisplay" style="display: none; padding: 10px; background: #333; margin-top: 10px; border-radius: 5px;">
        <span id="currentSymbol" style="font-weight: bold; color: #4CAF50;"></span>
        <span id="currentPrice" style="margin-left: 10px;"></span>
        <span id="priceChange" style="margin-left: 10px;"></span>
    </div>
    
    <div id="log">
        <h3>Debug Log:</h3>
    </div>

    <script>
        // API URL configuration
        let API_BASE_URL;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            API_BASE_URL = 'http://localhost:8000';
        } else if (window.location.hostname.includes('e2b.dev')) {
            API_BASE_URL = 'https://8000-i2ch499gc6d7qpm0yvxy4-6532622b.e2b.dev';
        } else {
            API_BASE_URL = 'https://enhanced-global-stock-tracker-frontend.onrender.com';
        }
        
        const logDiv = document.getElementById('log');
        let trackingInterval = null;
        let currentSymbol = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logDiv.innerHTML = '<h3>Debug Log:</h3>';
        }
        
        async function testStartTracking() {
            log('üöÄ testStartTracking called', 'info');
            
            try {
                // Get symbol
                const symbolFromDropdown = document.getElementById('marketSelect').value;
                const symbolFromInput = document.getElementById('symbolInput').value.trim().toUpperCase();
                const symbol = symbolFromDropdown || symbolFromInput;
                
                log(`üìä Symbol selected: ${symbol || 'NONE'}`, 'info');
                
                if (!symbol) {
                    log('‚ùå No symbol selected!', 'error');
                    alert('Please select a market or enter a symbol');
                    return;
                }
                
                // Stop existing tracking
                if (trackingInterval) {
                    clearInterval(trackingInterval);
                    log('‚èπÔ∏è Stopped existing tracking interval', 'info');
                }
                
                currentSymbol = symbol;
                
                // Show status
                document.getElementById('statusDisplay').style.display = 'block';
                document.getElementById('currentSymbol').textContent = symbol;
                
                // Update button
                const btn = document.getElementById('startBtn');
                btn.textContent = 'Loading...';
                btn.disabled = true;
                
                log(`üîó API URL: ${API_BASE_URL}`, 'info');
                log('üì° Fetching initial data...', 'info');
                
                // Fetch data
                await fetchMarketData(symbol);
                
                // Start interval
                trackingInterval = setInterval(() => {
                    log('üîÑ Auto-refresh triggered', 'info');
                    fetchMarketData(symbol);
                }, 30000);
                
                // Update button to stop
                btn.textContent = 'Stop Tracking';
                btn.disabled = false;
                btn.onclick = stopTracking;
                
                log('‚úÖ Tracking started successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Error in testStartTracking: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                
                // Reset button
                const btn = document.getElementById('startBtn');
                btn.textContent = 'Start Tracking';
                btn.disabled = false;
                btn.onclick = testStartTracking;
            }
        }
        
        async function fetchMarketData(symbol) {
            const url = `${API_BASE_URL}/api/stock/${symbol}?period=1d&interval=1h`;
            log(`üì• Fetching from: ${url}`, 'info');
            
            try {
                const response = await fetch(url);
                log(`üìä Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ Data received: ${data.data ? data.data.length : 0} points`, 'success');
                
                if (data && data.data && data.data.length > 0) {
                    const latest = data.data[data.data.length - 1];
                    const first = data.data[0];
                    const price = latest.close.toFixed(2);
                    const change = (latest.close - first.open).toFixed(2);
                    const changePercent = ((change / first.open) * 100).toFixed(2);
                    
                    document.getElementById('currentPrice').textContent = `$${price}`;
                    document.getElementById('priceChange').textContent = `${change >= 0 ? '+' : ''}${change} (${changePercent}%)`;
                    document.getElementById('priceChange').style.color = change >= 0 ? '#51cf66' : '#ff6b6b';
                    
                    log(`üí∞ Latest price: $${price} (${changePercent}% change)`, 'success');
                } else {
                    log('‚ö†Ô∏è No data points in response', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Fetch error: ${error.message}`, 'error');
            }
        }
        
        function stopTracking() {
            log('‚èπÔ∏è Stopping tracking...', 'info');
            
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            const btn = document.getElementById('startBtn');
            btn.textContent = 'Start Tracking';
            btn.onclick = testStartTracking;
            
            document.getElementById('statusDisplay').style.display = 'none';
            currentSymbol = '';
            
            log('‚úÖ Tracking stopped', 'success');
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            log(`üåê Page loaded`, 'info');
            log(`üìç Host: ${window.location.hostname}`, 'info');
            log(`üîó API URL: ${API_BASE_URL}`, 'info');
            log(`‚úÖ Ready to track!`, 'success');
        });
        
        // Test button click handler directly
        window.testButtonClick = function() {
            log('üñ±Ô∏è Button clicked directly!', 'success');
        };
    </script>
</body>
</html>