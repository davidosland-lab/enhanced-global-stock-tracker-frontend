<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Stock Market Tracker - Real-Time AEST</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .market-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .market-open { color: #10b981; }
        .market-closed { color: #ef4444; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
    </style>
</head>
<body class="text-gray-100">
    <nav class="bg-slate-900 border-b border-slate-700 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Global Stock Market Tracker
                </h1>
                <p class="text-sm text-gray-400 mt-1">Real-time market data in AEST timezone</p>
            </div>
            <div class="text-right">
                <div id="current-time" class="text-lg font-semibold"></div>
                <div id="last-update" class="text-sm text-gray-400"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 space-y-6">
        <!-- Market Hours Guide -->
        <div class="market-card rounded-xl p-4">
            <h2 class="text-lg font-semibold mb-3">Market Trading Hours (AEST)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <h3 class="font-medium text-red-400 mb-2">üåé Americas (Overnight)</h3>
                    <p>S&P 500, Dow, NASDAQ: <span class="text-white">00:30 - 07:00</span></p>
                    <p class="text-xs text-gray-500 mt-1">Trading before ASX opens</p>
                </div>
                <div>
                    <h3 class="font-medium text-blue-400 mb-2">üåè Asia-Pacific (Daytime)</h3>
                    <p>ASX 200, All Ords: <span class="text-white">10:00 - 16:00</span></p>
                    <p>Nikkei 225: <span class="text-white">10:00 - 15:00</span></p>
                </div>
                <div>
                    <h3 class="font-medium text-green-400 mb-2">üåç Europe (Evening)</h3>
                    <p>FTSE, DAX, CAC: <span class="text-white">18:00 - 02:30</span></p>
                    <p class="text-xs text-gray-500 mt-1">Next day closing</p>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="market-card rounded-xl p-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <label class="text-sm text-gray-400">Region:</label>
                    <select id="region-select" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600">
                        <option value="all">All Markets</option>
                        <option value="Americas">Americas</option>
                        <option value="Asia">Asia-Pacific</option>
                        <option value="Europe">Europe</option>
                    </select>
                    
                    <label class="text-sm text-gray-400 ml-4">Interval:</label>
                    <select id="interval-select" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600">
                        <option value="5m">5 Minutes</option>
                        <option value="15m">15 Minutes</option>
                        <option value="30m">30 Minutes</option>
                        <option value="1h">1 Hour</option>
                    </select>
                </div>
                
                <button id="refresh-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                    Refresh Data
                </button>
            </div>
        </div>

        <!-- Main Chart -->
        <div class="market-card rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Market Performance - % Change from Open</h2>
            <div id="chart-container" style="height: 400px; position: relative;">
                <canvas id="main-chart"></canvas>
                <div id="loading" class="absolute inset-0 flex items-center justify-center bg-slate-800/50 hidden">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Market Grid -->
        <div class="market-card rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Current Market Values</h2>
            <div id="market-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Market cards will be inserted here -->
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const BACKEND_URL = 'http://localhost:8000';
        let chartInstance = null;
        let currentRegion = 'all';
        let currentInterval = '5m';
        let marketData = {};
        let updateTimer = null;

        // Market configurations with colors
        const MARKET_CONFIG = {
            // Americas (Red tones) - Trade overnight
            "^GSPC": { name: "S&P 500", color: '#ef4444', region: 'Americas', order: 1 },
            "^DJI": { name: "Dow Jones", color: '#f87171', region: 'Americas', order: 2 },
            "^IXIC": { name: "NASDAQ", color: '#fca5a5', region: 'Americas', order: 3 },
            
            // Asia (Blue tones) - Trade during day
            "^AXJO": { name: "ASX 200", color: '#3b82f6', region: 'Asia', order: 4 },
            "^AORD": { name: "All Ordinaries", color: '#60a5fa', region: 'Asia', order: 5 },
            "^N225": { name: "Nikkei 225", color: '#93c5fd', region: 'Asia', order: 6 },
            "^HSI": { name: "Hang Seng", color: '#bfdbfe', region: 'Asia', order: 7 },
            
            // Europe (Green tones) - Trade in evening
            "^FTSE": { name: "FTSE 100", color: '#10b981', region: 'Europe', order: 8 },
            "^GDAXI": { name: "DAX", color: '#34d399', region: 'Europe', order: 9 },
            "^FCHI": { name: "CAC 40", color: '#6ee7b7', region: 'Europe', order: 10 }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart();
            loadAllData();
            setupEventListeners();
            startClock();
            
            // Auto-refresh every 30 seconds
            updateTimer = setInterval(loadAllData, 30000);
        });

        function setupEventListeners() {
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadAllData();
            });

            document.getElementById('region-select').addEventListener('change', (e) => {
                currentRegion = e.target.value;
                updateDisplay();
            });

            document.getElementById('interval-select').addEventListener('change', (e) => {
                currentInterval = e.target.value;
                loadAllData();
            });
        }

        function initializeChart() {
            const ctx = document.getElementById('main-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#fff',
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const symbol = value >= 0 ? '+' : '';
                                    return `${context.dataset.label}: ${symbol}${value.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            },
                            title: {
                                display: true,
                                text: 'Time (AEST)',
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Change from Open (%)',
                                color: '#9ca3af'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadAllData() {
            showLoading(true);
            
            try {
                // Load current market data
                const response = await fetch(`${BACKEND_URL}/api/indices`);
                const data = await response.json();
                marketData = data.indices || {};
                
                // Update market grid
                updateMarketGrid();
                
                // Load and display chart data
                await updateChart();
                
                // Update last refresh time
                const now = new Date();
                document.getElementById('last-update').textContent = 
                    `Last update: ${now.toLocaleTimeString('en-AU', {timeZone: 'Australia/Sydney'})}`;
                
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                showLoading(false);
            }
        }

        async function updateChart() {
            const datasets = [];
            const allLabels = new Set();
            const symbols = Object.keys(MARKET_CONFIG).filter(symbol => {
                if (currentRegion === 'all') return true;
                return MARKET_CONFIG[symbol].region === currentRegion;
            });

            // Sort symbols by configured order
            symbols.sort((a, b) => MARKET_CONFIG[a].order - MARKET_CONFIG[b].order);

            for (const symbol of symbols) {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/indices/${symbol}/history?period=1d`);
                    const data = await response.json();
                    
                    if (data.history && data.history.length > 0) {
                        const config = MARKET_CONFIG[symbol];
                        
                        // Process data points
                        const points = data.history.map(point => {
                            const time = new Date(point.timestamp);
                            const timeStr = time.toLocaleTimeString('en-AU', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false,
                                timeZone: 'Australia/Sydney'
                            });
                            
                            allLabels.add(timeStr);
                            
                            return {
                                x: timeStr,
                                y: point.changePercent
                            };
                        });

                        // Only add if we have data
                        if (points.length > 0) {
                            datasets.push({
                                label: config.name,
                                data: points,
                                borderColor: config.color,
                                backgroundColor: config.color + '20',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: false,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                pointBackgroundColor: config.color,
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            });
                        }
                    }
                } catch (error) {
                    console.error(`Error loading data for ${symbol}:`, error);
                }
            }

            // Sort labels chronologically and update chart
            const sortedLabels = Array.from(allLabels).sort();
            
            chartInstance.data.labels = sortedLabels;
            chartInstance.data.datasets = datasets;
            chartInstance.update('none'); // Update without animation for smoother refresh
        }

        function updateMarketGrid() {
            const grid = document.getElementById('market-grid');
            grid.innerHTML = '';
            
            // Sort by region and configured order
            const symbols = Object.keys(marketData).filter(symbol => {
                if (currentRegion === 'all') return true;
                const config = MARKET_CONFIG[symbol];
                return config && config.region === currentRegion;
            });
            
            symbols.sort((a, b) => {
                const configA = MARKET_CONFIG[a];
                const configB = MARKET_CONFIG[b];
                if (!configA || !configB) return 0;
                return configA.order - configB.order;
            });
            
            symbols.forEach(symbol => {
                const data = marketData[symbol];
                const config = MARKET_CONFIG[symbol];
                if (!config) return;
                
                const isPositive = data.changePercent >= 0;
                const statusClass = data.isOpen ? 'market-open' : 'market-closed';
                const changeClass = isPositive ? 'positive' : 'negative';
                const arrow = isPositive ? '‚ñ≤' : '‚ñº';
                
                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-lg p-4 border border-slate-700 hover:border-slate-600 transition-colors';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold">${config.name}</h3>
                        <span class="text-xs ${statusClass}">
                            ${data.isOpen ? '‚óè OPEN' : '‚óã CLOSED'}
                        </span>
                    </div>
                    <div class="text-2xl font-bold mb-2">
                        ${data.price ? data.price.toFixed(2) : '‚Äî'}
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="${changeClass} font-medium">
                            ${arrow} ${Math.abs(data.changePercent || 0).toFixed(2)}%
                        </span>
                        <span class="text-sm text-gray-400">
                            (${isPositive ? '+' : ''}${(data.change || 0).toFixed(2)})
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        Vol: ${formatVolume(data.volume || 0)}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function formatVolume(volume) {
            if (volume >= 1e9) return (volume / 1e9).toFixed(1) + 'B';
            if (volume >= 1e6) return (volume / 1e6).toFixed(1) + 'M';
            if (volume >= 1e3) return (volume / 1e3).toFixed(1) + 'K';
            return volume.toString();
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.toggle('hidden', !show);
            }
        }

        function startClock() {
            function updateClock() {
                const now = new Date();
                const aestTime = now.toLocaleString('en-AU', {
                    timeZone: 'Australia/Sydney',
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                document.getElementById('current-time').textContent = aestTime + ' AEST';
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }
    </script>
</body>
</html>