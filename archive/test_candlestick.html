<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candlestick Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .chart-container {
            position: relative;
            height: 500px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            background: #333;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Candlestick Chart Test</h1>
    <div>
        <button onclick="testBasicChart()">Test Basic Line Chart</button>
        <button onclick="testCandlestickChart()">Test Candlestick Chart</button>
        <button onclick="fetchAndDisplay()">Fetch Real Data</button>
    </div>
    <div id="status">Status: Ready</div>
    <div class="chart-container">
        <canvas id="testChart"></canvas>
    </div>

    <!-- Chart.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.js"></script>

    <script>
        let chart = null;
        const API_BASE = 'https://8000-i2ch499gc6d7qpm0yvxy4-6532622b.e2b.dev';

        function updateStatus(msg) {
            document.getElementById('status').innerHTML = `Status: ${msg}`;
            console.log(msg);
        }

        function destroyChart() {
            if (chart) {
                chart.destroy();
                chart = null;
            }
        }

        function testBasicChart() {
            updateStatus('Creating basic line chart...');
            destroyChart();
            
            const ctx = document.getElementById('testChart').getContext('2d');
            
            try {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
                        datasets: [{
                            label: 'Test Data',
                            data: [100, 110, 105, 115, 120],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                updateStatus('Basic line chart created successfully!');
            } catch (error) {
                updateStatus('Error: ' + error.message);
                console.error(error);
            }
        }

        function testCandlestickChart() {
            updateStatus('Creating candlestick chart with dummy data...');
            destroyChart();
            
            const ctx = document.getElementById('testChart').getContext('2d');
            
            // Simple test data
            const testData = [
                {x: 'Day 1', o: 100, h: 105, l: 98, c: 103},
                {x: 'Day 2', o: 103, h: 108, l: 102, c: 107},
                {x: 'Day 3', o: 107, h: 110, l: 105, c: 106},
                {x: 'Day 4', o: 106, h: 108, l: 104, c: 108},
                {x: 'Day 5', o: 108, h: 112, l: 107, c: 111}
            ];
            
            try {
                chart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: 'Test Candlestick',
                            data: testData,
                            borderColor: '#000',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                type: 'category'
                            },
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
                updateStatus('Candlestick chart created successfully!');
            } catch (error) {
                updateStatus('Error creating candlestick: ' + error.message);
                console.error(error);
            }
        }

        async function fetchAndDisplay() {
            updateStatus('Fetching real data from API...');
            
            try {
                const response = await fetch(`${API_BASE}/api/technical/candlestick-data/AAPL?period=1mo&interval=1d`);
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    throw new Error('Invalid API response');
                }
                
                updateStatus(`Received ${result.data.length} data points. Creating chart...`);
                
                destroyChart();
                const ctx = document.getElementById('testChart').getContext('2d');
                
                // Transform data for candlestick chart
                const candleData = result.data.map((item, idx) => ({
                    x: new Date(item.timestamp).toLocaleDateString(),
                    o: item.open,
                    h: item.high,
                    l: item.low,
                    c: item.close
                }));
                
                console.log('Candle data sample:', candleData.slice(0, 3));
                
                chart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: 'AAPL',
                            data: candleData,
                            borderColor: '#333',
                            borderWidth: 1,
                            color: {
                                up: '#26a69a',
                                down: '#ef5350',
                                unchanged: '#999'
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return [
                                            `Open: $${point.o.toFixed(2)}`,
                                            `High: $${point.h.toFixed(2)}`,
                                            `Low: $${point.l.toFixed(2)}`,
                                            `Close: $${point.c.toFixed(2)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'category',
                                ticks: {
                                    color: '#ccc'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    color: '#ccc',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
                
                updateStatus(`Chart created with ${result.data.length} candlesticks!`);
                
            } catch (error) {
                updateStatus('Error: ' + error.message);
                console.error('Full error:', error);
            }
        }

        // Log versions on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Chart.js version:', Chart.version);
            console.log('Available chart types:', Chart.registry.controllers);
            if (Chart.registry.controllers.candlestick) {
                updateStatus('Candlestick controller is registered âœ“');
            } else {
                updateStatus('WARNING: Candlestick controller not found!');
            }
        });
    </script>
</body>
</html>