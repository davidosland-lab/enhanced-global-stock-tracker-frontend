<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinBERT v4.0 - Professional Trading System</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f2c 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 600px;
            margin-bottom: 10px;
        }

        .volume-chart-container {
            position: relative;
            width: 100%;
            height: 200px;
            margin-top: 10px;
        }

        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prediction-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .prediction-BUY {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .prediction-SELL {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .prediction-HOLD {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid #eab308;
        }

        .chart-type-btn {
            padding: 8px 16px;
            margin: 0 4px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .chart-type-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #e2e8f0;
        }

        .chart-type-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .interval-btn {
            padding: 6px 12px;
            margin: 2px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .interval-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .interval-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            margin: 2% auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 900px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 5px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 5px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }

        .progress-bar {
            height: 6px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
        }

        .train-log {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin-top: 15px;
        }

        .lstm-indicator {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 8px;
        }

        .confidence-bar {
            height: 6px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="p-6">
    <!-- Header -->
    <div class="glass-panel p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-brain text-blue-500"></i> FinBERT v4.0
                    <span class="lstm-indicator">LSTM ENHANCED</span>
                </h1>
                <p class="text-gray-400">Professional Trading System with Candlestick Charts</p>
            </div>
            <div class="text-right flex gap-3">
                <button onclick="openBacktestModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                    <i class="fas fa-chart-line mr-2"></i> Backtest Strategy
                </button>
                <button onclick="openPortfolioBacktestModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition">
                    <i class="fas fa-briefcase mr-2"></i> Portfolio Backtest
                </button>
                <button onclick="openTrainModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                    <i class="fas fa-dumbbell mr-2"></i> Train Model
                </button>
            </div>
        </div>
    </div>

    <!-- Market Selector & Search -->
    <div class="glass-panel p-6 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex gap-2">
                <button class="chart-type-btn active" data-type="candlestick" onclick="switchChartType('candlestick')">
                    <i class="fas fa-chart-candlestick mr-2"></i> Candlestick
                </button>
                <button class="chart-type-btn" data-type="line" onclick="switchChartType('line')">
                    <i class="fas fa-chart-line mr-2"></i> Line
                </button>
            </div>

            <div class="flex-1">
                <input 
                    type="text" 
                    id="symbolInput" 
                    placeholder="Enter stock symbol (e.g., AAPL or CBA.AX for ASX)"
                    class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                >
            </div>

            <button 
                onclick="analyzeStock()" 
                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition"
            >
                <i class="fas fa-chart-line mr-2"></i> Analyze
            </button>
        </div>

        <!-- Quick Access -->
        <div class="mt-4">
            <div class="text-sm text-gray-400 mb-2">Quick Access:</div>
            <div class="flex flex-wrap gap-2">
                <button onclick="selectQuickSymbol('AAPL')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">AAPL</button>
                <button onclick="selectQuickSymbol('MSFT')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">MSFT</button>
                <button onclick="selectQuickSymbol('GOOGL')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">GOOGL</button>
                <button onclick="selectQuickSymbol('TSLA')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">TSLA</button>
                <button onclick="selectQuickSymbol('CBA.AX')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">CBA.AX</button>
                <button onclick="selectQuickSymbol('BHP.AX')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">BHP.AX</button>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Chart Panel (2/3 width) -->
        <div class="lg:col-span-2">
            <div class="glass-panel p-6">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold" id="chartTitle">Select a stock to begin</h2>
                        <div class="flex gap-2">
                            <button class="chart-type-btn" onclick="switchChartType('line')">Line</button>
                            <button class="chart-type-btn" onclick="switchChartType('candlestick')">Candlestick</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <div class="text-xs text-gray-400 mr-2 py-1">Intraday:</div>
                        <button class="interval-btn" data-period="1d" data-interval="1m" onclick="changePeriod('1d', '1m')">1min</button>
                        <button class="interval-btn" data-period="1d" data-interval="3m" onclick="changePeriod('1d', '3m')">3min</button>
                        <button class="interval-btn" data-period="1d" data-interval="5m" onclick="changePeriod('1d', '5m')">5min</button>
                        <button class="interval-btn" data-period="1d" data-interval="15m" onclick="changePeriod('1d', '15m')">15min</button>
                        <div class="border-l border-gray-600 mx-2"></div>
                        <div class="text-xs text-gray-400 mr-2 py-1">Periods:</div>
                        <button class="interval-btn" data-period="1d" data-interval="1d" onclick="changePeriod('1d', '1d')">1D</button>
                        <button class="interval-btn" data-period="5d" data-interval="1d" onclick="changePeriod('5d', '1d')">5D</button>
                        <button class="interval-btn active" data-period="1mo" data-interval="1d" onclick="changePeriod('1mo', '1d')">1M</button>
                        <button class="interval-btn" data-period="3mo" data-interval="1d" onclick="changePeriod('3mo', '1d')">3M</button>
                        <button class="interval-btn" data-period="6mo" data-interval="1d" onclick="changePeriod('6mo', '1d')">6M</button>
                        <button class="interval-btn" data-period="1y" data-interval="1d" onclick="changePeriod('1y', '1d')">1Y</button>
                        <button class="interval-btn" data-period="2y" data-interval="1d" onclick="changePeriod('2y', '1d')">2Y</button>
                    </div>
                </div>
                
                <!-- Price Chart -->
                <div class="chart-container">
                    <div id="priceChart" style="width: 100%; height: 100%;"></div>
                </div>

                <!-- Volume Chart -->
                <div class="volume-chart-container">
                    <div id="volumeChart" style="width: 100%; height: 100%;"></div>
                </div>

                <div id="loadingIndicator" class="hidden flex justify-center items-center h-64">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Prediction & Stats Panel (1/3 width) -->
        <div class="space-y-6">
            <!-- ML Prediction Card -->
            <div class="glass-panel p-6">
                <h3 class="text-lg font-bold mb-4">
                    <i class="fas fa-robot text-purple-500"></i> AI Prediction
                </h3>
                
                <div id="predictionContent" class="text-center text-gray-500">
                    <i class="fas fa-chart-line text-4xl mb-3 opacity-30"></i>
                    <p>Analyze a stock to see predictions</p>
                </div>

                <div id="predictionData" class="hidden">
                    <!-- Current Price Display (Prominent) -->
                    <div class="text-center mb-4 pb-4 border-b border-gray-700">
                        <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Current Price</div>
                        <div class="text-4xl font-bold mb-1" id="currentPriceDisplay">$0.00</div>
                        <div class="text-sm" id="currentPriceChange">+$0.00 (+0.00%)</div>
                    </div>

                    <!-- Prediction Display -->
                    <div class="text-center mb-4">
                        <div class="text-xs text-gray-400 uppercase tracking-wide mb-2">AI Prediction</div>
                        <div id="predictionBadge" class="prediction-badge mb-3">HOLD</div>
                        <div class="text-2xl font-bold mb-1" id="predictedPrice">$0.00</div>
                        <div class="text-sm text-gray-400" id="priceChange">+$0.00 (+0.00%)</div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-400">Confidence</span>
                            <span class="font-semibold" id="confidenceValue">0%</span>
                        </div>
                        <div class="confidence-bar">
                            <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Model Type</span>
                            <span class="font-semibold" id="modelType">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FinBERT Sentiment Card -->
            <div class="glass-panel p-6">
                <h3 class="text-lg font-bold mb-4">
                    <i class="fas fa-brain text-green-500"></i> FinBERT Sentiment
                </h3>
                
                <div id="sentimentContent" class="text-center text-gray-500">
                    <i class="fas fa-comments text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm">Analyzing market sentiment...</p>
                </div>

                <div id="sentimentData" class="hidden">
                    <!-- Sentiment Badge -->
                    <div class="text-center mb-4">
                        <div id="sentimentBadge" class="prediction-badge mb-2">NEUTRAL</div>
                        <div class="text-sm text-gray-400">Market Sentiment</div>
                    </div>

                    <!-- Sentiment Scores -->
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-green-400">Positive</span>
                                <span id="sentimentPositive">0%</span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="sentimentPositiveBar" class="h-full bg-green-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">Neutral</span>
                                <span id="sentimentNeutral">0%</span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="sentimentNeutralBar" class="h-full bg-gray-400" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-red-400">Negative</span>
                                <span id="sentimentNegative">0%</span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="sentimentNegativeBar" class="h-full bg-red-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="pt-3 border-t border-gray-700">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Compound Score</span>
                                <span class="font-semibold" id="sentimentCompound">0.00</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <span class="text-gray-400">Confidence</span>
                                <span class="font-semibold" id="sentimentConfidence">0%</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <span class="text-gray-400">Articles Analyzed</span>
                                <span class="font-semibold" id="sentimentArticleCount">0</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-2" id="sentimentMethod">Method: FinBERT</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Stats Card -->
            <div class="glass-panel p-6">
                <h3 class="text-lg font-bold mb-4">
                    <i class="fas fa-chart-bar text-blue-500"></i> Market Data
                </h3>
                
                <div id="statsContent" class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Day High</span>
                        <span class="font-bold" id="dayHigh">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Day Low</span>
                        <span class="font-bold" id="dayLow">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Volume</span>
                        <span class="font-bold" id="volume">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Change</span>
                        <span class="font-bold" id="change">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- News Articles Section (Full Width) -->
    <div id="newsArticlesSection" class="mt-6 hidden">
        <div class="glass-panel p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">
                    <i class="fas fa-newspaper text-yellow-500"></i> Recent News & Sentiment Analysis
                </h3>
                <div class="text-sm text-gray-400" id="newsSourceInfo">Source: Finviz + Yahoo Finance</div>
            </div>
            
            <div id="newsArticlesList" class="space-y-4">
                <!-- Articles will be dynamically inserted here -->
            </div>
            
            <div id="noNewsMessage" class="text-center text-gray-500 py-8 hidden">
                <i class="fas fa-info-circle text-4xl mb-3 opacity-30"></i>
                <p>No recent news articles found for this stock.</p>
            </div>
        </div>
    </div>

    <!-- Training Modal -->
    <div id="trainModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-dumbbell text-purple-500 mr-2"></i> Train LSTM Model
                </h2>
                <button onclick="closeTrainModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Stock Symbol</label>
                    <input 
                        type="text" 
                        id="trainSymbol" 
                        placeholder="e.g., AAPL or CBA.AX"
                        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Epochs (Training Iterations)</label>
                    <input 
                        type="number" 
                        id="trainEpochs" 
                        value="50"
                        min="10"
                        max="200"
                        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                    <p class="text-xs text-gray-400 mt-1">Recommended: 50-100 (Higher = More accurate but slower)</p>
                </div>

                <div id="trainingProgress" class="hidden">
                    <div class="flex justify-between text-sm mb-2">
                        <span>Training Progress</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>

                    <div id="trainLog" class="train-log mt-3">
                        <div class="text-green-400">Starting training...</div>
                    </div>
                </div>

                <button 
                    id="startTrainBtn"
                    onclick="startTraining()" 
                    class="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition"
                >
                    <i class="fas fa-play mr-2"></i> Start Training
                </button>
            </div>
        </div>
    </div>

    <!-- Backtesting Modal -->
    <div id="backtestModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-800 z-10 pb-4 pt-2 -mt-8 px-8 -mx-8">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-chart-line text-blue-500 mr-2"></i> Backtest Strategy
                </h2>
                <button onclick="closeBacktestModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4 px-1">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Stock Symbol</label>
                        <input 
                            type="text" 
                            id="backtestSymbol" 
                            placeholder="e.g., AAPL or CBA.AX"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Model Type</label>
                        <select 
                            id="backtestModel" 
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                            <option value="ensemble">Ensemble (Recommended - LSTM + Technical + Momentum)</option>
                            <option value="lstm">LSTM Neural Network</option>
                            <option value="technical">Technical Analysis</option>
                            <option value="momentum">Momentum Strategy</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Start Date</label>
                        <input 
                            type="date" 
                            id="backtestStartDate" 
                            value="2023-01-01"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">End Date</label>
                        <input 
                            type="date" 
                            id="backtestEndDate" 
                            value="2023-12-31"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Initial Capital ($)</label>
                        <input 
                            type="number" 
                            id="backtestCapital" 
                            value="10000"
                            min="1000"
                            step="1000"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Lookback Days</label>
                        <input 
                            type="number" 
                            id="backtestLookback" 
                            value="60"
                            min="10"
                            max="200"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>
                </div>

                <div id="backtestProgress" class="hidden">
                    <div class="flex justify-between text-sm mb-2">
                        <span>Backtest Progress</span>
                        <span id="backtestProgressPercent">Running...</span>
                    </div>
                    <div class="progress-bar">
                        <div id="backtestProgressFill" class="progress-fill" style="width: 50%"></div>
                    </div>
                </div>

                <div id="backtestResults" class="hidden">
                    <div class="bg-slate-800 rounded-lg p-4 mt-4">
                        <h3 class="text-lg font-bold mb-3">Backtest Results</h3>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-gray-400">Total Return</div>
                                <div class="text-2xl font-bold" id="backtestReturn">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Total Trades</div>
                                <div class="text-2xl font-bold" id="backtestTrades">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Win Rate</div>
                                <div class="text-xl font-semibold" id="backtestWinRate">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Sharpe Ratio</div>
                                <div class="text-xl font-semibold" id="backtestSharpe">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Max Drawdown</div>
                                <div class="text-xl font-semibold" id="backtestDrawdown">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Profit Factor</div>
                                <div class="text-xl font-semibold" id="backtestProfitFactor">--</div>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <div class="text-sm text-gray-400 mb-2">Final Equity</div>
                            <div class="text-3xl font-bold" id="backtestFinalEquity">$0</div>
                        </div>
                    </div>
                    
                    <!-- Visualization Charts -->
                    <div id="backtestCharts" class="hidden mt-4 space-y-4">
                        <!-- Equity Curve Chart -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-line text-green-500 mr-2"></i>
                                Equity Curve
                            </h4>
                            <div id="equityCurveChart" style="width: 100%; height: 300px;"></div>
                        </div>
                        
                        <!-- Drawdown Chart -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-area text-red-500 mr-2"></i>
                                Drawdown Analysis
                            </h4>
                            <div id="drawdownChart" style="width: 100%; height: 250px;"></div>
                        </div>
                        
                        <!-- Trade Distribution Chart -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                                Trade Distribution
                            </h4>
                            <div id="tradeDistributionChart" style="width: 100%; height: 300px;"></div>
                        </div>
                        
                        <!-- Monthly Returns Heatmap -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-calendar-alt text-purple-500 mr-2"></i>
                                Monthly Returns
                            </h4>
                            <div id="monthlyReturnsChart" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>

                <button 
                    id="startBacktestBtn"
                    onclick="startBacktest()" 
                    class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition"
                >
                    <i class="fas fa-play mr-2"></i> Run Backtest
                </button>
            </div>
        </div>
    </div>

    <!-- Portfolio Backtesting Modal -->
    <div id="portfolioBacktestModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-800 z-10 pb-4 pt-2 -mt-8 px-8 -mx-8">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-briefcase text-indigo-500 mr-2"></i> Portfolio Backtest
                </h2>
                <button onclick="closePortfolioBacktestModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4 px-1">
                <!-- Stock Symbols -->
                <div>
                    <label class="block text-sm font-semibold mb-2">
                        Stock Symbols (comma-separated)
                        <span class="text-gray-400 font-normal ml-2">e.g., AAPL, MSFT, GOOGL</span>
                    </label>
                    <input 
                        type="text" 
                        id="portfolioSymbols" 
                        placeholder="Enter 2 or more symbols"
                        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                    <div class="text-xs text-gray-400 mt-1">Minimum 2 stocks required for portfolio backtest</div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Model Type</label>
                        <select 
                            id="portfolioModel" 
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                            <option value="ensemble">Ensemble (Recommended)</option>
                            <option value="lstm">LSTM Neural Network</option>
                            <option value="technical">Technical Analysis</option>
                            <option value="momentum">Momentum Strategy</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Allocation Strategy</label>
                        <select 
                            id="portfolioAllocation" 
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                            onchange="toggleCustomAllocations()"
                        >
                            <option value="equal">Equal Weight</option>
                            <option value="risk_parity">Risk Parity (Inverse Volatility)</option>
                            <option value="custom">Custom Weights</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Allocations (hidden by default) -->
                <div id="customAllocationsDiv" class="hidden">
                    <label class="block text-sm font-semibold mb-2">
                        Custom Allocations
                        <span class="text-gray-400 font-normal ml-2">Must sum to 100%</span>
                    </label>
                    <textarea 
                        id="customAllocations" 
                        placeholder='{"AAPL": 0.4, "MSFT": 0.35, "GOOGL": 0.25}'
                        rows="3"
                        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none font-mono text-sm"
                    ></textarea>
                    <div class="text-xs text-gray-400 mt-1">Enter as JSON object. Values should sum to 1.0</div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Start Date</label>
                        <input 
                            type="date" 
                            id="portfolioStartDate" 
                            value="2023-01-01"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">End Date</label>
                        <input 
                            type="date" 
                            id="portfolioEndDate" 
                            value="2023-12-31"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Initial Capital ($)</label>
                        <input 
                            type="number" 
                            id="portfolioCapital" 
                            value="10000"
                            min="1000"
                            step="1000"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Rebalance Frequency</label>
                        <select 
                            id="portfolioRebalance" 
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                            <option value="monthly">Monthly</option>
                            <option value="never">Never</option>
                            <option value="weekly">Weekly</option>
                            <option value="quarterly">Quarterly</option>
                        </select>
                    </div>
                </div>

                <div id="portfolioProgress" class="hidden">
                    <div class="flex justify-between text-sm mb-2">
                        <span>Portfolio Backtest Progress</span>
                        <span id="portfolioProgressPercent">Running...</span>
                    </div>
                    <div class="progress-bar">
                        <div id="portfolioProgressFill" class="progress-fill" style="width: 50%"></div>
                    </div>
                </div>

                <div id="portfolioResults" class="hidden">
                    <div class="bg-slate-800 rounded-lg p-4 mt-4">
                        <h3 class="text-lg font-bold mb-3">Portfolio Results</h3>
                        
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="text-gray-400">Total Return</div>
                                <div class="text-2xl font-bold" id="portfolioReturn">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Sharpe Ratio</div>
                                <div class="text-2xl font-bold" id="portfolioSharpe">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Max Drawdown</div>
                                <div class="text-2xl font-bold" id="portfolioDrawdown">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Total Trades</div>
                                <div class="text-xl font-semibold" id="portfolioTrades">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Win Rate</div>
                                <div class="text-xl font-semibold" id="portfolioWinRate">--</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Profit Factor</div>
                                <div class="text-xl font-semibold" id="portfolioProfitFactor">--</div>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-400 mb-2">Final Portfolio Value</div>
                                    <div class="text-3xl font-bold" id="portfolioFinalValue">$0</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-400 mb-2">Stocks Traded</div>
                                    <div class="text-3xl font-bold" id="portfolioStocks">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Diversification Metrics -->
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                                Diversification Analysis
                            </h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-400">Avg Correlation</div>
                                    <div class="text-lg font-semibold" id="portfolioAvgCorr">--</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Diversification Ratio</div>
                                    <div class="text-lg font-semibold" id="portfolioDivRatio">--</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Effective Stocks</div>
                                    <div class="text-lg font-semibold" id="portfolioEffStocks">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Charts -->
                    <div id="portfolioCharts" class="hidden mt-4 space-y-4">
                        <!-- Portfolio Equity Curve -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-line text-green-500 mr-2"></i>
                                Portfolio Equity Curve
                            </h4>
                            <div id="portfolioEquityChart" style="width: 100%; height: 300px;"></div>
                        </div>
                        
                        <!-- Allocation Breakdown -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-pie text-blue-500 mr-2"></i>
                                Current Allocation
                            </h4>
                            <div id="portfolioAllocationChart" style="width: 100%; height: 300px;"></div>
                        </div>
                        
                        <!-- Contribution Analysis -->
                        <div class="bg-slate-800 rounded-lg p-4">
                            <h4 class="text-md font-semibold mb-3">
                                <i class="fas fa-chart-bar text-indigo-500 mr-2"></i>
                                Stock Contribution to Returns
                            </h4>
                            <div id="portfolioContributionChart" style="width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <button 
                    id="startPortfolioBacktestBtn"
                    onclick="startPortfolioBacktest()" 
                    class="w-full px-6 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition"
                >
                    <i class="fas fa-play mr-2"></i> Run Portfolio Backtest
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5001' 
            : window.location.origin;

        let currentSymbol = '';
        let currentPeriod = '1mo';
        let currentInterval = '1d';
        let currentChartType = 'candlestick';
        let priceChart = null;
        let volumeChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
        });

        // Enter key in search
        document.getElementById('symbolInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        function selectQuickSymbol(symbol) {
            document.getElementById('symbolInput').value = symbol;
            analyzeStock();
        }

        function switchChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === type) {
                    btn.classList.add('active');
                }
            });
            if (currentSymbol) {
                analyzeStock();
            }
        }

        function changePeriod(period, interval = '1d') {
            currentPeriod = period;
            currentInterval = interval;
            document.querySelectorAll('.interval-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.period === period && btn.dataset.interval === interval) {
                    btn.classList.add('active');
                }
            });
            if (currentSymbol) {
                analyzeStock();
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                console.log('Health check:', data);
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        async function analyzeStock() {
            const input = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (!input) {
                alert('Please enter a stock symbol');
                return;
            }

            currentSymbol = input;
            document.getElementById('chartTitle').textContent = `${currentSymbol} Analysis`;

            // Show loading
            document.getElementById('loadingIndicator').classList.remove('hidden');
            if (priceChart) {
                priceChart.dispose();
                priceChart = null;
            }
            if (volumeChart) {
                volumeChart.dispose();
                volumeChart = null;
            }

            try {
                const response = await fetch(`${API_BASE}/api/stock/${currentSymbol}?period=${currentPeriod}&interval=${currentInterval}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide loading
                document.getElementById('loadingIndicator').classList.add('hidden');
                
                // Update prediction
                updatePrediction(data);
                
                // Update sentiment
                updateSentiment(data);
                
                // Update stats
                updateStats(data);
                
                // Update charts
                updateCharts(data);
                
            } catch (error) {
                console.error('Error analyzing stock:', error);
                alert(`Failed to analyze ${currentSymbol}. Please check the symbol and try again.`);
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        function updatePrediction(data) {
            const prediction = data.ml_prediction;
            
            if (!prediction) {
                return;
            }

            // Show prediction data
            document.getElementById('predictionContent').classList.add('hidden');
            document.getElementById('predictionData').classList.remove('hidden');

            // Update CURRENT PRICE (Prominent Display)
            const currentPrice = data.current_price;
            const previousClose = data.previous_close || currentPrice;
            const currentChange = currentPrice - previousClose;
            const currentChangePercent = (currentChange / previousClose * 100).toFixed(2);
            const currentColor = currentChange >= 0 ? 'text-green-400' : 'text-red-400';
            const currentSign = currentChange >= 0 ? '+' : '';

            document.getElementById('currentPriceDisplay').textContent = 
                `$${currentPrice.toFixed(2)}`;
            document.getElementById('currentPriceChange').innerHTML = 
                `<span class="${currentColor}">${currentSign}$${currentChange.toFixed(2)} (${currentSign}${currentChangePercent}%)</span>`;

            // Update prediction badge
            const badge = document.getElementById('predictionBadge');
            badge.textContent = prediction.prediction;
            badge.className = `prediction-badge prediction-${prediction.prediction}`;

            // Update PREDICTED PRICE
            document.getElementById('predictedPrice').textContent = 
                `$${prediction.predicted_price.toFixed(2)}`;

            const change = prediction.predicted_price - currentPrice;
            const changePercent = (change / currentPrice * 100).toFixed(2);
            const changeColor = change >= 0 ? 'text-green-400' : 'text-red-400';
            const changeSign = change >= 0 ? '+' : '';
            
            document.getElementById('priceChange').innerHTML = 
                `<span class="${changeColor}">${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent}%)</span>`;

            // Update confidence
            const confidence = Math.round(prediction.confidence);
            document.getElementById('confidenceValue').textContent = `${confidence}%`;
            document.getElementById('confidenceFill').style.width = `${confidence}%`;

            // Update model info
            document.getElementById('modelType').textContent = prediction.model_type || 'Technical';
        }

        function updateStats(data) {
            document.getElementById('dayHigh').textContent = `$${data.day_high.toFixed(2)}`;
            document.getElementById('dayLow').textContent = `$${data.day_low.toFixed(2)}`;
            
            const volume = data.volume;
            const volumeStr = volume > 1000000 
                ? `${(volume / 1000000).toFixed(2)}M` 
                : `${(volume / 1000).toFixed(2)}K`;
            document.getElementById('volume').textContent = volumeStr;

            const change = data.price_change;
            const changePercent = data.price_change_percent;
            const changeColor = change >= 0 ? 'text-green-400' : 'text-red-400';
            const changeSign = change >= 0 ? '+' : '';
            
            document.getElementById('change').innerHTML = 
                `<span class="${changeColor}">${changeSign}$${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)</span>`;
        }

        function updateSentiment(data) {
            // Check if sentiment data is available
            const sentiment = data.ml_prediction?.sentiment;
            
            if (!sentiment) {
                // Show placeholder
                document.getElementById('sentimentContent').classList.remove('hidden');
                document.getElementById('sentimentData').classList.add('hidden');
                return;
            }

            // Hide placeholder and show data
            document.getElementById('sentimentContent').classList.add('hidden');
            document.getElementById('sentimentData').classList.remove('hidden');

            // Update sentiment badge
            const sentimentLabel = sentiment.sentiment?.toUpperCase() || 'NEUTRAL';
            const sentimentBadge = document.getElementById('sentimentBadge');
            sentimentBadge.textContent = sentimentLabel;
            sentimentBadge.className = `prediction-badge prediction-${sentimentLabel}`;

            // Update sentiment scores
            const scores = sentiment.scores || { positive: 0, neutral: 0, negative: 0 };
            const positivePercent = (scores.positive * 100).toFixed(1);
            const neutralPercent = (scores.neutral * 100).toFixed(1);
            const negativePercent = (scores.negative * 100).toFixed(1);

            document.getElementById('sentimentPositive').textContent = `${positivePercent}%`;
            document.getElementById('sentimentPositiveBar').style.width = `${positivePercent}%`;

            document.getElementById('sentimentNeutral').textContent = `${neutralPercent}%`;
            document.getElementById('sentimentNeutralBar').style.width = `${neutralPercent}%`;

            document.getElementById('sentimentNegative').textContent = `${negativePercent}%`;
            document.getElementById('sentimentNegativeBar').style.width = `${negativePercent}%`;

            // Update compound score and confidence
            const compound = sentiment.compound || 0;
            const compoundColor = compound > 0 ? 'text-green-400' : compound < 0 ? 'text-red-400' : 'text-gray-400';
            document.getElementById('sentimentCompound').innerHTML = 
                `<span class="${compoundColor}">${compound.toFixed(3)}</span>`;

            document.getElementById('sentimentConfidence').textContent = `${sentiment.confidence?.toFixed(1) || 0}%`;
            
            // Update article count
            const articleCount = sentiment.article_count || sentiment.articles?.length || 0;
            document.getElementById('sentimentArticleCount').textContent = articleCount;
            
            // Update method
            const method = sentiment.method || 'FinBERT';
            const isMock = sentiment.is_mock ? ' (Demo Data)' : '';
            document.getElementById('sentimentMethod').textContent = `Method: ${method}${isMock}`;
            
            // Update news articles section
            updateNewsArticles(sentiment);
        }

        function updateNewsArticles(sentiment) {
            const articles = sentiment.articles || [];
            const newsSection = document.getElementById('newsArticlesSection');
            const articlesList = document.getElementById('newsArticlesList');
            const noNewsMessage = document.getElementById('noNewsMessage');
            
            if (articles.length === 0) {
                newsSection.classList.add('hidden');
                return;
            }
            
            // Show news section
            newsSection.classList.remove('hidden');
            noNewsMessage.classList.add('hidden');
            
            // Clear previous articles
            articlesList.innerHTML = '';
            
            // Create article cards
            articles.forEach((article, index) => {
                const articleCard = document.createElement('div');
                articleCard.className = 'glass-panel p-4 hover:bg-slate-700/30 transition';
                
                // Determine sentiment color
                const sentimentLabel = article.sentiment || 'neutral';
                let sentimentColor = 'text-gray-400';
                let sentimentBg = 'bg-gray-500/20';
                let sentimentIcon = 'fa-minus';
                
                if (sentimentLabel === 'positive') {
                    sentimentColor = 'text-green-400';
                    sentimentBg = 'bg-green-500/20';
                    sentimentIcon = 'fa-arrow-up';
                } else if (sentimentLabel === 'negative') {
                    sentimentColor = 'text-red-400';
                    sentimentBg = 'bg-red-500/20';
                    sentimentIcon = 'fa-arrow-down';
                }
                
                // Format sentiment score
                const score = article.sentiment_score || 0;
                const scorePercent = (Math.abs(score) * 100).toFixed(1);
                
                // Format date
                const dateStr = article.published || 'Recent';
                
                articleCard.innerHTML = `
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 text-center">
                            <div class="${sentimentBg} ${sentimentColor} w-16 h-16 rounded-lg flex items-center justify-center">
                                <i class="fas ${sentimentIcon} text-2xl"></i>
                            </div>
                            <div class="text-xs mt-1 ${sentimentColor} font-semibold">${scorePercent}%</div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <h4 class="font-semibold text-white hover:text-blue-400 transition cursor-pointer" 
                                    onclick="window.open('${article.url || '#'}', '_blank')">
                                    ${article.title || 'Untitled'}
                                </h4>
                                <span class="text-xs text-gray-500 whitespace-nowrap">${dateStr}</span>
                            </div>
                            ${article.summary && article.summary.trim() ? `<p class="text-sm text-gray-400 mb-2 line-clamp-2">${article.summary}</p>` : ''}
                            <div class="flex items-center gap-4 text-xs text-gray-500">
                                <span><i class="fas fa-globe mr-1"></i> ${article.source || 'Unknown'}</span>
                                <span class="uppercase ${sentimentColor}">${sentimentLabel}</span>
                                ${article.confidence ? `<span>Confidence: ${(article.confidence * 100).toFixed(0)}%</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                articlesList.appendChild(articleCard);
            });
        }

        function updateCharts(data) {
            const chartData = data.chart_data || [];

            if (chartData.length === 0) {
                return;
            }

            if (currentChartType === 'candlestick') {
                createCandlestickChart(chartData);
            } else {
                createLineChart(chartData);
            }

            createVolumeChart(chartData);
        }

        function createCandlestickChart(chartData) {
            // Dispose previous chart if exists
            if (priceChart) {
                priceChart.dispose();
            }

            // Initialize ECharts instance
            const chartDom = document.getElementById('priceChart');
            priceChart = echarts.init(chartDom);

            // Prepare data for ECharts
            const dates = chartData.map(d => d.date);
            const candlestickData = chartData.map(d => [d.open, d.close, d.low, d.high]);

            // Configure chart options
            const option = {
                backgroundColor: 'transparent',
                animation: true,
                grid: {
                    left: '3%',
                    right: '3%',
                    top: '10%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    },
                    axisLabel: {
                        color: '#94a3b8',
                        formatter: function(value) {
                            const date = new Date(value);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }
                    },
                    splitLine: {
                        show: false
                    }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    },
                    axisLabel: {
                        color: '#94a3b8',
                        formatter: (value) => `$${value.toFixed(2)}`
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    textStyle: {
                        color: '#e2e8f0'
                    },
                    formatter: function(params) {
                        const data = params[0];
                        const values = data.data;
                        return `
                            <strong>${data.name}</strong><br/>
                            Open: $${values[0].toFixed(2)}<br/>
                            Close: $${values[1].toFixed(2)}<br/>
                            Low: $${values[2].toFixed(2)}<br/>
                            High: $${values[3].toFixed(2)}
                        `;
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: 10,
                        start: 0,
                        end: 100,
                        backgroundColor: 'rgba(51, 65, 85, 0.5)',
                        fillerColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        handleStyle: {
                            color: '#3b82f6'
                        },
                        textStyle: {
                            color: '#94a3b8'
                        }
                    }
                ],
                series: [{
                    type: 'candlestick',
                    name: currentSymbol,
                    data: candlestickData,
                    itemStyle: {
                        color: '#10b981',
                        color0: '#ef4444',
                        borderColor: '#10b981',
                        borderColor0: '#ef4444'
                    }
                }]
            };

            priceChart.setOption(option);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (priceChart) {
                    priceChart.resize();
                }
            });
        }

        function createLineChart(chartData) {
            // Dispose previous chart if exists
            if (priceChart) {
                priceChart.dispose();
            }

            // Initialize ECharts instance
            const chartDom = document.getElementById('priceChart');
            priceChart = echarts.init(chartDom);

            // Prepare data
            const dates = chartData.map(d => d.date);
            const prices = chartData.map(d => d.close);

            // Configure chart options
            const option = {
                backgroundColor: 'transparent',
                animation: true,
                grid: {
                    left: '3%',
                    right: '3%',
                    top: '10%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    },
                    axisLabel: {
                        color: '#94a3b8',
                        formatter: function(value) {
                            const date = new Date(value);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }
                    },
                    splitLine: {
                        show: false
                    }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    },
                    axisLabel: {
                        color: '#94a3b8',
                        formatter: (value) => `$${value.toFixed(2)}`
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    textStyle: {
                        color: '#e2e8f0'
                    },
                    formatter: function(params) {
                        const data = params[0];
                        return `<strong>${data.name}</strong><br/>Price: $${data.value.toFixed(2)}`;
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: 10,
                        start: 0,
                        end: 100,
                        backgroundColor: 'rgba(51, 65, 85, 0.5)',
                        fillerColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        handleStyle: {
                            color: '#3b82f6'
                        },
                        textStyle: {
                            color: '#94a3b8'
                        }
                    }
                ],
                series: [{
                    type: 'line',
                    name: currentSymbol,
                    data: prices,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        color: '#3b82f6',
                        width: 2
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0,
                                color: 'rgba(59, 130, 246, 0.3)'
                            }, {
                                offset: 1,
                                color: 'rgba(59, 130, 246, 0.0)'
                            }]
                        }
                    }
                }]
            };

            priceChart.setOption(option);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (priceChart) {
                    priceChart.resize();
                }
            });
        }

        function createVolumeChart(chartData) {
            // Dispose previous chart if exists
            if (volumeChart) {
                volumeChart.dispose();
            }

            // Initialize ECharts instance
            const chartDom = document.getElementById('volumeChart');
            volumeChart = echarts.init(chartDom);

            // Prepare data
            const dates = chartData.map(d => d.date);
            const volumes = chartData.map(d => d.volume);
            
            // Color bars based on price movement
            const volumeData = chartData.map((d, i) => {
                let color = '#6b7280';
                if (i > 0) {
                    color = d.close >= chartData[i-1].close ? '#10b981' : '#ef4444';
                }
                return {
                    value: d.volume,
                    itemStyle: { color: color }
                };
            });

            // Configure chart options
            const option = {
                backgroundColor: 'transparent',
                animation: true,
                grid: {
                    left: '3%',
                    right: '3%',
                    top: '5%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    axisLabel: {
                        show: false
                    },
                    splitLine: {
                        show: false
                    }
                },
                yAxis: {
                    type: 'value',
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    },
                    axisLabel: {
                        color: '#94a3b8',
                        formatter: function(value) {
                            return value > 1000000 
                                ? `${(value / 1000000).toFixed(0)}M` 
                                : `${(value / 1000).toFixed(0)}K`;
                        }
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    textStyle: {
                        color: '#e2e8f0'
                    },
                    formatter: function(params) {
                        const data = params[0];
                        const vol = data.value;
                        const volStr = vol > 1000000 
                            ? `${(vol / 1000000).toFixed(2)}M` 
                            : `${(vol / 1000).toFixed(2)}K`;
                        return `<strong>${data.name}</strong><br/>Volume: ${volStr}`;
                    }
                },
                series: [{
                    type: 'bar',
                    name: 'Volume',
                    data: volumeData,
                    barMaxWidth: 10
                }]
            };

            volumeChart.setOption(option);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (volumeChart) {
                    volumeChart.resize();
                }
            });
        }

        // Training Modal Functions
        function openTrainModal() {
            document.getElementById('trainModal').style.display = 'block';
            const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (symbol) {
                document.getElementById('trainSymbol').value = symbol;
            }
        }

        function closeTrainModal() {
            document.getElementById('trainModal').style.display = 'none';
            document.getElementById('trainingProgress').classList.add('hidden');
        }

        async function startTraining() {
            const symbol = document.getElementById('trainSymbol').value.trim().toUpperCase();
            const epochs = parseInt(document.getElementById('trainEpochs').value);

            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }

            if (epochs < 10 || epochs > 200) {
                alert('Please enter epochs between 10 and 200');
                return;
            }

            // Show progress
            document.getElementById('trainingProgress').classList.remove('hidden');
            document.getElementById('startTrainBtn').disabled = true;
            document.getElementById('startTrainBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Training...';

            const logDiv = document.getElementById('trainLog');
            logDiv.innerHTML = '<div class="text-green-400">Initializing training...</div>';

            try {
                // Simulate training progress (since actual training is async)
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 2;
                    if (progress <= 90) {
                        document.getElementById('progressFill').style.width = `${progress}%`;
                        document.getElementById('progressPercent').textContent = `${progress}%`;
                        
                        if (progress % 10 === 0) {
                            logDiv.innerHTML += `<div class="text-blue-400">Epoch ${Math.floor(progress/2)}/${epochs} - Training...</div>`;
                            logDiv.scrollTop = logDiv.scrollHeight;
                        }
                    }
                }, 1000);

                const response = await fetch(`${API_BASE}/api/train/${symbol}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        epochs: epochs,
                        sequence_length: 30
                    })
                });

                clearInterval(progressInterval);

                if (!response.ok) {
                    throw new Error(`Training failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Complete progress
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressPercent').textContent = '100%';
                
                logDiv.innerHTML += `<div class="text-green-400 font-bold"> Training completed successfully!</div>`;
                logDiv.innerHTML += `<div class="text-gray-400">Model saved for ${symbol}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;

                // Re-enable button
                setTimeout(() => {
                    document.getElementById('startTrainBtn').disabled = false;
                    document.getElementById('startTrainBtn').innerHTML = '<i class="fas fa-check mr-2"></i> Training Complete!';
                    
                    setTimeout(() => {
                        closeTrainModal();
                        document.getElementById('startTrainBtn').innerHTML = '<i class="fas fa-play mr-2"></i> Start Training';
                        
                        // Refresh analysis if same symbol
                        if (currentSymbol === symbol) {
                            analyzeStock();
                        }
                    }, 2000);
                }, 1000);

            } catch (error) {
                console.error('Training error:', error);
                logDiv.innerHTML += `<div class="text-red-400"> Training failed: ${error.message}</div>`;
                
                document.getElementById('startTrainBtn').disabled = false;
                document.getElementById('startTrainBtn').innerHTML = '<i class="fas fa-play mr-2"></i> Retry Training';
            }
        }

        // Backtesting Modal Functions
        function openBacktestModal() {
            document.getElementById('backtestModal').style.display = 'block';
            const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (symbol) {
                document.getElementById('backtestSymbol').value = symbol;
            }
            
            // Set default end date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('backtestEndDate').value = today;
            
            // Set start date to 1 year ago
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            document.getElementById('backtestStartDate').value = oneYearAgo.toISOString().split('T')[0];
        }

        function closeBacktestModal() {
            document.getElementById('backtestModal').style.display = 'none';
            document.getElementById('backtestProgress').classList.add('hidden');
            document.getElementById('backtestResults').classList.add('hidden');
            document.getElementById('backtestCharts').classList.add('hidden');
        }

        async function startBacktest() {
            const symbol = document.getElementById('backtestSymbol').value.trim().toUpperCase();
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const modelType = document.getElementById('backtestModel').value;
            const initialCapital = parseInt(document.getElementById('backtestCapital').value);
            const lookbackDays = parseInt(document.getElementById('backtestLookback').value);

            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }

            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }

            // Show progress
            document.getElementById('backtestProgress').classList.remove('hidden');
            document.getElementById('backtestResults').classList.add('hidden');
            document.getElementById('startBacktestBtn').disabled = true;
            document.getElementById('startBacktestBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Running Backtest...';

            try {
                const response = await fetch(`${API_BASE}/api/backtest/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        start_date: startDate,
                        end_date: endDate,
                        model_type: modelType,
                        initial_capital: initialCapital,
                        lookback_days: lookbackDays
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Backtest failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Hide progress
                document.getElementById('backtestProgress').classList.add('hidden');
                
                // Show results
                document.getElementById('backtestResults').classList.remove('hidden');
                
                // Update result fields
                const perf = result.performance;
                const returnPct = perf.total_return_pct || 0;
                const returnColor = returnPct >= 0 ? 'text-green-400' : 'text-red-400';
                
                document.getElementById('backtestReturn').innerHTML = `<span class="${returnColor}">${returnPct >= 0 ? '+' : ''}${returnPct.toFixed(2)}%</span>`;
                document.getElementById('backtestTrades').textContent = perf.total_trades || 0;
                document.getElementById('backtestWinRate').textContent = `${(perf.win_rate || 0).toFixed(1)}%`;
                document.getElementById('backtestSharpe').textContent = (perf.sharpe_ratio || 0).toFixed(2);
                document.getElementById('backtestDrawdown').textContent = `${(perf.max_drawdown_pct || 0).toFixed(2)}%`;
                document.getElementById('backtestProfitFactor').textContent = (perf.profit_factor || 0).toFixed(2);
                document.getElementById('backtestFinalEquity').innerHTML = `<span class="${returnColor}">$${(perf.final_equity || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`;

                // Update button
                document.getElementById('startBacktestBtn').disabled = false;
                document.getElementById('startBacktestBtn').innerHTML = '<i class="fas fa-check mr-2"></i> Backtest Complete!';
                
                // Show success message
                console.log('Backtest Results:', result);
                console.log('Performance data:', perf);
                console.log('Charts data:', perf.charts);
                
                // Display charts if data is available
                if (perf.charts && Object.keys(perf.charts).length > 0) {
                    console.log('Displaying charts...');
                    document.getElementById('backtestCharts').classList.remove('hidden');
                    displayBacktestCharts(perf.charts);
                } else {
                    console.warn('No chart data available:', perf.charts);
                }

            } catch (error) {
                console.error('Backtest error:', error);
                alert(`Backtest failed: ${error.message}`);
                
                document.getElementById('backtestProgress').classList.add('hidden');
                document.getElementById('startBacktestBtn').disabled = false;
                document.getElementById('startBacktestBtn').innerHTML = '<i class="fas fa-play mr-2"></i> Run Backtest';
            }
        }

        // Display backtest visualization charts
        function displayBacktestCharts(charts) {
            if (!charts) return;
            
            // Display Equity Curve
            if (charts.equity_curve && charts.equity_curve.length > 0) {
                displayEquityCurve(charts.equity_curve);
            }
            
            // Display Drawdown Chart
            if (charts.drawdown_curve && charts.drawdown_curve.length > 0) {
                displayDrawdownChart(charts.drawdown_curve);
            }
            
            // Display Trade Distribution
            if (charts.trade_distribution) {
                displayTradeDistribution(charts.trade_distribution);
            }
            
            // Display Monthly Returns
            if (charts.monthly_returns) {
                displayMonthlyReturns(charts.monthly_returns);
            }
        }
        
        function displayEquityCurve(data) {
            const chartDiv = document.getElementById('equityCurveChart');
            const chart = echarts.init(chartDiv);
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Portfolio Value Over Time',
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    formatter: function(params) {
                        const date = params[0].name;
                        const equity = params[0].value;
                        const cash = params[1].value;
                        const positions = params[2].value;
                        return `${date}<br/>
                                <span style="color: #10B981;"> Total Equity: $${equity.toLocaleString()}</span><br/>
                                <span style="color: #3B82F6;"> Cash: $${cash.toLocaleString()}</span><br/>
                                <span style="color: #F59E0B;"> Positions: $${positions.toLocaleString()}</span>`;
                    }
                },
                legend: {
                    data: ['Total Equity', 'Cash', 'Positions Value'],
                    textStyle: { color: '#94a3b8' },
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '80',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.map(d => d.timestamp),
                    axisLabel: { color: '#64748b', rotate: 45 },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#64748b',
                        formatter: '${value}'
                    },
                    axisLine: { lineStyle: { color: '#334155' } },
                    splitLine: { lineStyle: { color: '#1e293b', type: 'dashed' } }
                },
                series: [
                    {
                        name: 'Total Equity',
                        type: 'line',
                        data: data.map(d => d.equity),
                        smooth: true,
                        lineStyle: { color: '#10B981', width: 3 },
                        itemStyle: { color: '#10B981' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                                    { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                                ]
                            }
                        }
                    },
                    {
                        name: 'Cash',
                        type: 'line',
                        data: data.map(d => d.cash),
                        smooth: true,
                        lineStyle: { color: '#3B82F6', width: 2 },
                        itemStyle: { color: '#3B82F6' }
                    },
                    {
                        name: 'Positions Value',
                        type: 'line',
                        data: data.map(d => d.positions_value),
                        smooth: true,
                        lineStyle: { color: '#F59E0B', width: 2 },
                        itemStyle: { color: '#F59E0B' }
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        function displayDrawdownChart(data) {
            const chartDiv = document.getElementById('drawdownChart');
            const chart = echarts.init(chartDiv);
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Drawdown from Peak',
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    formatter: function(params) {
                        const date = params[0].name;
                        const drawdown = params[0].value;
                        const peak = params[0].data.peak;
                        const equity = params[0].data.equity;
                        return `${date}<br/>
                                <span style="color: #EF4444;"> Drawdown: ${drawdown.toFixed(2)}%</span><br/>
                                <span style="color: #94a3b8;">Peak: $${peak.toLocaleString()}</span><br/>
                                <span style="color: #94a3b8;">Current: $${equity.toLocaleString()}</span>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '60',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.map(d => d.timestamp),
                    axisLabel: { color: '#64748b', rotate: 45 },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#64748b',
                        formatter: '{value}%'
                    },
                    axisLine: { lineStyle: { color: '#334155' } },
                    splitLine: { lineStyle: { color: '#1e293b', type: 'dashed' } }
                },
                series: [{
                    name: 'Drawdown',
                    type: 'line',
                    data: data.map(d => ({
                        value: d.drawdown,
                        peak: d.peak,
                        equity: d.equity
                    })),
                    smooth: true,
                    lineStyle: { color: '#EF4444', width: 2 },
                    itemStyle: { color: '#EF4444' },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                                { offset: 1, color: 'rgba(239, 68, 68, 0.05)' }
                            ]
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        function displayTradeDistribution(data) {
            const chartDiv = document.getElementById('tradeDistributionChart');
            const chart = echarts.init(chartDiv);
            
            const buckets = data.buckets;
            const labels = data.labels;
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Trade P&L Distribution',
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '60',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLabel: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#334155' } },
                    splitLine: { lineStyle: { color: '#1e293b', type: 'dashed' } }
                },
                series: [{
                    name: 'Number of Trades',
                    type: 'bar',
                    data: [
                        { value: buckets.large_loss, itemStyle: { color: '#DC2626' } },
                        { value: buckets.medium_loss, itemStyle: { color: '#EF4444' } },
                        { value: buckets.small_loss, itemStyle: { color: '#F87171' } },
                        { value: buckets.small_win, itemStyle: { color: '#34D399' } },
                        { value: buckets.medium_win, itemStyle: { color: '#10B981' } },
                        { value: buckets.large_win, itemStyle: { color: '#059669' } }
                    ],
                    barWidth: '60%'
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        function displayMonthlyReturns(data) {
            const chartDiv = document.getElementById('monthlyReturnsChart');
            const chart = echarts.init(chartDiv);
            
            const months = data.months || [];
            const returns = data.returns || [];
            
            if (months.length === 0) {
                chartDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">No monthly data available</div>';
                return;
            }
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Monthly Returns (%)',
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    formatter: function(params) {
                        const month = params[0].name;
                        const ret = params[0].value;
                        const color = ret >= 0 ? '#10B981' : '#EF4444';
                        return `${month}<br/><span style="color: ${color};">Return: ${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%</span>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '60',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: months,
                    axisLabel: { color: '#64748b', rotate: 45 },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#64748b',
                        formatter: '{value}%'
                    },
                    axisLine: { lineStyle: { color: '#334155' } },
                    splitLine: { lineStyle: { color: '#1e293b', type: 'dashed' } }
                },
                series: [{
                    name: 'Monthly Return',
                    type: 'bar',
                    data: returns.map(ret => ({
                        value: ret,
                        itemStyle: {
                            color: ret >= 0 ? '#10B981' : '#EF4444'
                        }
                    })),
                    barWidth: '60%'
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // Portfolio Backtesting Functions
        function openPortfolioBacktestModal() {
            document.getElementById('portfolioBacktestModal').style.display = 'block';
            // Set default dates (last year)
            const today = new Date();
            document.getElementById('portfolioEndDate').value = today.toISOString().split('T')[0];
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            document.getElementById('portfolioStartDate').value = oneYearAgo.toISOString().split('T')[0];
        }

        function closePortfolioBacktestModal() {
            document.getElementById('portfolioBacktestModal').style.display = 'none';
            document.getElementById('portfolioProgress').classList.add('hidden');
            document.getElementById('portfolioResults').classList.add('hidden');
            document.getElementById('portfolioCharts').classList.add('hidden');
        }

        function toggleCustomAllocations() {
            const strategy = document.getElementById('portfolioAllocation').value;
            const customDiv = document.getElementById('customAllocationsDiv');
            if (strategy === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        }

        async function startPortfolioBacktest() {
            const symbolsInput = document.getElementById('portfolioSymbols').value.trim();
            const startDate = document.getElementById('portfolioStartDate').value;
            const endDate = document.getElementById('portfolioEndDate').value;
            const modelType = document.getElementById('portfolioModel').value;
            const initialCapital = parseInt(document.getElementById('portfolioCapital').value);
            const allocationStrategy = document.getElementById('portfolioAllocation').value;
            const rebalanceFrequency = document.getElementById('portfolioRebalance').value;

            // Parse symbols
            const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s.length > 0);

            // Validation
            if (symbols.length < 2) {
                alert('Please enter at least 2 stock symbols');
                return;
            }

            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }

            // Parse custom allocations if needed
            let customAllocations = null;
            if (allocationStrategy === 'custom') {
                try {
                    const allocText = document.getElementById('customAllocations').value.trim();
                    if (allocText) {
                        customAllocations = JSON.parse(allocText);
                        // Validate sum to 1.0
                        const sum = Object.values(customAllocations).reduce((a, b) => a + b, 0);
                        if (Math.abs(sum - 1.0) > 0.01) {
                            alert(`Custom allocations must sum to 1.0 (current sum: ${sum.toFixed(2)})`);
                            return;
                        }
                    } else {
                        alert('Please enter custom allocations for the custom strategy');
                        return;
                    }
                } catch (e) {
                    alert('Invalid JSON format for custom allocations');
                    return;
                }
            }

            // Show progress
            document.getElementById('portfolioProgress').classList.remove('hidden');
            document.getElementById('portfolioResults').classList.add('hidden');
            document.getElementById('startPortfolioBacktestBtn').disabled = true;
            document.getElementById('startPortfolioBacktestBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Running Portfolio Backtest...';

            try {
                const requestBody = {
                    symbols: symbols,
                    start_date: startDate,
                    end_date: endDate,
                    model_type: modelType,
                    initial_capital: initialCapital,
                    allocation_strategy: allocationStrategy,
                    rebalance_frequency: rebalanceFrequency
                };

                if (customAllocations) {
                    requestBody.custom_allocations = customAllocations;
                }

                const response = await fetch(`${API_BASE}/api/backtest/portfolio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Portfolio backtest failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Hide progress
                document.getElementById('portfolioProgress').classList.add('hidden');
                
                // Show results
                document.getElementById('portfolioResults').classList.remove('hidden');
                
                // Update result fields
                const metrics = result.portfolio_metrics;
                const returnPct = metrics.total_return_pct || 0;
                const returnColor = returnPct >= 0 ? 'text-green-400' : 'text-red-400';
                
                document.getElementById('portfolioReturn').innerHTML = `<span class="${returnColor}">${returnPct >= 0 ? '+' : ''}${returnPct.toFixed(2)}%</span>`;
                document.getElementById('portfolioSharpe').textContent = (metrics.sharpe_ratio || 0).toFixed(2);
                document.getElementById('portfolioDrawdown').textContent = `${(metrics.max_drawdown_pct || 0).toFixed(2)}%`;
                document.getElementById('portfolioTrades').textContent = metrics.total_trades || 0;
                document.getElementById('portfolioWinRate').textContent = `${(metrics.win_rate || 0).toFixed(1)}%`;
                document.getElementById('portfolioProfitFactor').textContent = (metrics.profit_factor || 0).toFixed(2);
                document.getElementById('portfolioFinalValue').innerHTML = `<span class="${returnColor}">$${(metrics.final_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>`;
                document.getElementById('portfolioStocks').textContent = metrics.num_symbols || 0;

                // Diversification metrics
                const div = result.diversification || {};
                document.getElementById('portfolioAvgCorr').textContent = (div.avg_correlation || 0).toFixed(3);
                document.getElementById('portfolioDivRatio').textContent = (div.diversification_ratio || 0).toFixed(3);
                document.getElementById('portfolioEffStocks').textContent = (div.effective_num_stocks || 0).toFixed(1);

                // Update button
                document.getElementById('startPortfolioBacktestBtn').disabled = false;
                document.getElementById('startPortfolioBacktestBtn').innerHTML = '<i class="fas fa-check mr-2"></i> Portfolio Backtest Complete!';
                
                console.log('Portfolio Backtest Results:', result);
                
                // Display charts if data is available
                if (metrics.charts && Object.keys(metrics.charts).length > 0) {
                    console.log('Displaying portfolio charts...');
                    document.getElementById('portfolioCharts').classList.remove('hidden');
                    displayPortfolioCharts(metrics.charts);
                } else {
                    console.warn('No chart data available');
                }

            } catch (error) {
                alert('Portfolio Backtest Error: ' + error.message);
                console.error('Portfolio backtest error:', error);
                document.getElementById('portfolioProgress').classList.add('hidden');
                document.getElementById('startPortfolioBacktestBtn').disabled = false;
                document.getElementById('startPortfolioBacktestBtn').innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Try Again';
            }
        }

        function displayPortfolioCharts(charts) {
            // Portfolio Equity Curve
            if (charts.equity_curve && charts.equity_curve.length > 0) {
                displayPortfolioEquityCurve(charts.equity_curve);
            }

            // Allocation Pie Chart
            if (charts.allocation_pie) {
                displayAllocationPie(charts.allocation_pie);
            }

            // Contribution Analysis
            if (charts.contribution_analysis) {
                displayContributionChart(charts.contribution_analysis);
            }
        }

        function displayPortfolioEquityCurve(data) {
            const chartDiv = document.getElementById('portfolioEquityChart');
            const chart = echarts.init(chartDiv);
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Portfolio Value Over Time',
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(p => {
                            result += `${p.marker} ${p.seriesName}: $${p.value.toLocaleString()}<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Total Equity', 'Cash', 'Positions Value'],
                    textStyle: { color: '#94a3b8' },
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.map(d => d.timestamp),
                    axisLabel: { 
                        color: '#64748b',
                        rotate: 45,
                        interval: Math.floor(data.length / 10)
                    },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { 
                        color: '#64748b',
                        formatter: '${value}'
                    },
                    splitLine: { lineStyle: { color: '#1e293b' } },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                series: [
                    {
                        name: 'Total Equity',
                        type: 'line',
                        data: data.map(d => d.equity),
                        smooth: true,
                        lineStyle: { color: '#10B981', width: 3 },
                        itemStyle: { color: '#10B981' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(16, 185, 129, 0.4)' },
                                    { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                                ]
                            }
                        }
                    },
                    {
                        name: 'Cash',
                        type: 'line',
                        data: data.map(d => d.cash),
                        smooth: true,
                        lineStyle: { color: '#3b82f6', width: 2 },
                        itemStyle: { color: '#3b82f6' }
                    },
                    {
                        name: 'Positions Value',
                        type: 'line',
                        data: data.map(d => d.positions_value),
                        smooth: true,
                        lineStyle: { color: '#8b5cf6', width: 2 },
                        itemStyle: { color: '#8b5cf6' }
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        function displayAllocationPie(data) {
            if (!data.symbols || data.symbols.length === 0) return;

            const chartDiv = document.getElementById('portfolioAllocationChart');
            const chart = echarts.init(chartDiv);
            
            const pieData = data.symbols.map((symbol, idx) => ({
                name: symbol,
                value: data.values[idx]
            }));
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Portfolio Allocation',
                    subtext: `Total: $${data.total_value.toLocaleString()}`,
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    subtextStyle: { color: '#64748b' },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    formatter: '{b}: ${c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: '5%',
                    top: 'center',
                    textStyle: { color: '#94a3b8' }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    data: pieData,
                    label: {
                        color: '#e2e8f0',
                        formatter: '{b}\n{d}%'
                    },
                    itemStyle: {
                        borderRadius: 5,
                        borderColor: '#1e293b',
                        borderWidth: 2
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        function displayContributionChart(data) {
            if (!data.symbols || data.symbols.length === 0) return;

            const chartDiv = document.getElementById('portfolioContributionChart');
            const chart = echarts.init(chartDiv);
            
            // Sort by contribution
            const sorted = data.symbols.map((symbol, idx) => ({
                symbol: symbol,
                contribution: data.contributions[idx]
            })).sort((a, b) => b.contribution - a.contribution);
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: 'Contribution to Portfolio Returns',
                    textStyle: { color: '#94a3b8', fontSize: 14 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#475569',
                    textStyle: { color: '#e2e8f0' },
                    formatter: '{b}: ${c}'
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    top: '15%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: sorted.map(d => d.symbol),
                    axisLabel: { color: '#64748b' },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { 
                        color: '#64748b',
                        formatter: '${value}'
                    },
                    splitLine: { lineStyle: { color: '#1e293b' } },
                    axisLine: { lineStyle: { color: '#334155' } }
                },
                series: [{
                    type: 'bar',
                    data: sorted.map(d => ({
                        value: d.contribution,
                        itemStyle: {
                            color: d.contribution >= 0 ? '#10B981' : '#EF4444'
                        }
                    })),
                    barWidth: '60%',
                    label: {
                        show: true,
                        position: 'top',
                        color: '#e2e8f0',
                        formatter: '${c}'
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const trainModal = document.getElementById('trainModal');
            const backtestModal = document.getElementById('backtestModal');
            const portfolioModal = document.getElementById('portfolioBacktestModal');
            
            if (event.target == trainModal) {
                closeTrainModal();
            } else if (event.target == backtestModal) {
                closeBacktestModal();
            } else if (event.target == portfolioModal) {
                closePortfolioBacktestModal();
            }
        }
    </script>
</body>
</html>