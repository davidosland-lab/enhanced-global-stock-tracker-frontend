<!DOCTYPE html>
<html>
<head>
    <title>Candlestick Test</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
    <div id="chart" style="width: 800px; height: 400px;"></div>
    <button onclick="testCandlestick()">Test Candlestick</button>
    
    <script>
        async function testCandlestick() {
            console.log('üß™ Testing candlestick with actual market data...');
            
            try {
                // Get real market data from our API
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols: ['AAPL'],
                        chart_type: 'candlestick',
                        interval_minutes: 60,
                        time_period: '24h'
                    })
                });
                
                const data = await response.json();
                console.log('üìä Received data:', data);
                
                // Extract candlestick data
                const points = data.data['AAPL'];
                console.log('üìä Points count:', points.length);
                
                // Try to create ECharts candlestick - replicating the exact issue
                const chart = echarts.init(document.getElementById('chart'));
                
                // This is what's failing - let's see the exact data structure
                const candlestickData = [];
                const xAxisData = [];
                
                points.forEach((point, index) => {
                    console.log(`Point ${index}:`, {
                        market_open: point.market_open,
                        ohlc: [point.open, point.close, point.low, point.high],
                        hasNulls: [point.open, point.close, point.low, point.high].includes(null)
                    });
                    
                    if (point.market_open && point.open !== null && point.high !== null && 
                        point.low !== null && point.close !== null) {
                        candlestickData.push([point.open, point.close, point.low, point.high]);
                        xAxisData.push(`${index}`);
                    } else {
                        // This might be the issue - adding null to the array
                        candlestickData.push(null);
                        xAxisData.push(`${index}`);
                    }
                });
                
                console.log('üïØÔ∏è Candlestick data array:', candlestickData);
                console.log('üïØÔ∏è Null count in data:', candlestickData.filter(d => d === null).length);
                
                const option = {
                    title: { text: 'Candlestick Test' },
                    xAxis: {
                        type: 'category',
                        data: xAxisData
                    },
                    yAxis: { type: 'value' },
                    series: [{
                        type: 'candlestick',
                        data: candlestickData
                    }]
                };
                
                console.log('üìä About to set ECharts option...');
                chart.setOption(option);
                console.log('‚úÖ ECharts option set successfully');
                
            } catch (error) {
                console.error('‚ùå Candlestick test failed:', error);
                console.error('‚ùå Error stack:', error.stack);
            }
        }
    </script>
</body>
</html>
