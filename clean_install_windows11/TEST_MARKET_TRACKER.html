<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Tracker Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #444;
            border-radius: 10px;
            margin-top: 20px;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <h1>Market Tracker Test Page</h1>
    
    <div class="test-section">
        <h2>Browser & Cache Status</h2>
        <p id="cacheStatus">Checking cache...</p>
        <button onclick="clearAndReload()">Clear Cache & Reload</button>
        <button onclick="testTrackers()">Test All Trackers</button>
    </div>
    
    <div class="test-section">
        <h2>Available Tracker Files</h2>
        <div id="fileList"></div>
    </div>
    
    <div class="test-section">
        <h2>Direct Links (Open in New Tab)</h2>
        <button onclick="window.open('modules/indices_tracker.html', '_blank')">
            Open indices_tracker.html
        </button>
        <button onclick="window.open('modules/indices_tracker_fixed_times.html', '_blank')">
            Open Fixed ADST Version
        </button>
        <button onclick="window.open('modules/market-tracking/market_tracker_final.html', '_blank')">
            Open market_tracker_final.html
        </button>
    </div>
    
    <div class="test-section">
        <h2>Embedded Tracker (Testing)</h2>
        <select id="trackerSelect" onchange="loadTracker(this.value)">
            <option value="">Select a tracker to test...</option>
            <option value="modules/indices_tracker.html">indices_tracker.html</option>
            <option value="modules/indices_tracker_fixed_times.html">indices_tracker_fixed_times.html</option>
            <option value="modules/market-tracking/market_tracker_final.html">market_tracker_final.html</option>
        </select>
        <iframe id="trackerFrame" style="display:none;"></iframe>
    </div>
    
    <div class="test-section">
        <h2>Console Output</h2>
        <pre id="consoleOutput" style="background: black; padding: 10px; max-height: 200px; overflow-y: auto;"></pre>
    </div>

    <script>
        // Override console.error to capture errors
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');
        let errorCount = 0;
        
        console.error = function(...args) {
            errorCount++;
            const errorMsg = args.join(' ');
            consoleOutput.innerHTML += `<span class="error">[ERROR ${errorCount}] ${errorMsg}</span>\n`;
            originalError.apply(console, args);
        };
        
        // Check cache status
        function checkCacheStatus() {
            const cacheStatus = document.getElementById('cacheStatus');
            const lastCleared = localStorage.getItem('cacheLastCleared');
            
            if (lastCleared) {
                const date = new Date(lastCleared);
                cacheStatus.innerHTML = `<span class="success">Cache last cleared: ${date.toLocaleString()}</span>`;
            } else {
                cacheStatus.innerHTML = `<span class="warning">Cache status unknown. Consider clearing cache if you see errors.</span>`;
            }
        }
        
        // Clear cache and reload
        function clearAndReload() {
            localStorage.setItem('cacheLastCleared', new Date().toISOString());
            if (confirm('This will reload the page. Continue?')) {
                location.reload(true);
            }
        }
        
        // Test all tracker files
        async function testTrackers() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = 'Testing tracker files...<br><br>';
            
            const files = [
                'modules/indices_tracker.html',
                'modules/indices_tracker_fixed_times.html',
                'modules/market-tracking/market_tracker_final.html',
                'modules/global_market_tracker.html'
            ];
            
            for (const file of files) {
                try {
                    const response = await fetch(file);
                    if (response.ok) {
                        const text = await response.text();
                        const hasADST = text.includes('ADST');
                        const hasGetADSTTime = text.includes('getADSTTime');
                        
                        fileList.innerHTML += `<div class="success">✓ ${file}</div>`;
                        if (hasADST && hasGetADSTTime) {
                            fileList.innerHTML += `<div class="success" style="margin-left: 20px;">→ Has ADST timezone fix</div>`;
                        } else {
                            fileList.innerHTML += `<div class="warning" style="margin-left: 20px;">→ Missing ADST timezone fix</div>`;
                        }
                    } else {
                        fileList.innerHTML += `<div class="error">✗ ${file} (${response.status})</div>`;
                    }
                } catch (error) {
                    fileList.innerHTML += `<div class="error">✗ ${file} (${error.message})</div>`;
                }
            }
        }
        
        // Load tracker in iframe
        function loadTracker(file) {
            const iframe = document.getElementById('trackerFrame');
            if (file) {
                iframe.src = file;
                iframe.style.display = 'block';
                consoleOutput.innerHTML += `<span class="success">Loading: ${file}</span>\n`;
            } else {
                iframe.style.display = 'none';
            }
        }
        
        // Initialize
        checkCacheStatus();
        testTrackers();
        
        // Show current time in ADST
        setInterval(() => {
            const now = new Date();
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const adstTime = new Date(utcTime + (11 * 3600000));
            
            document.title = `Market Test - ADST: ${adstTime.toLocaleTimeString()}`;
        }, 1000);
    </script>
</body>
</html>