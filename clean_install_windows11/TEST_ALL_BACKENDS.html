<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backend Endpoint Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #2d5a2d;
            border: 1px solid #4CAF50;
        }
        .error {
            background: #5a2d2d;
            border: 1px solid #f44336;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        h2 {
            color: #4CAF50;
        }
        .endpoint {
            font-family: monospace;
            background: #333;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Stock Tracker Backend Endpoint Tester</h1>
    <p>This page tests all backend endpoints to identify which are working.</p>
    
    <button onclick="testAllEndpoints()">Test All Endpoints</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <h2>Test Results:</h2>
    <div id="results"></div>

    <script>
        const BACKEND_URL = 'http://localhost:8002';
        const ML_BACKEND_URL = 'http://localhost:8003';
        
        const endpoints = [
            // Main Backend (8002)
            { url: `${BACKEND_URL}/api/health`, method: 'GET', name: 'Backend Health' },
            { url: `${BACKEND_URL}/api/stock/CBA.AX`, method: 'GET', name: 'Stock Data (CBA.AX)' },
            { url: `${BACKEND_URL}/api/stock/AAPL`, method: 'GET', name: 'Stock Data (AAPL)' },
            { url: `${BACKEND_URL}/api/stock/%5EAORD`, method: 'GET', name: 'Index Data (^AORD)' },
            { url: `${BACKEND_URL}/api/historical/symbols`, method: 'GET', name: 'Historical Symbols' },
            { url: `${BACKEND_URL}/api/historical/CBA.AX`, method: 'GET', name: 'Historical Data (CBA.AX)' },
            { url: `${BACKEND_URL}/api/indices`, method: 'GET', name: 'Market Indices' },
            { url: `${BACKEND_URL}/api/market-movers`, method: 'GET', name: 'Market Movers' },
            
            // ML Backend (8003)
            { url: `${ML_BACKEND_URL}/health`, method: 'GET', name: 'ML Backend Health' },
            { url: `${ML_BACKEND_URL}/api/ml/models`, method: 'GET', name: 'ML Models List' },
            { url: `${ML_BACKEND_URL}/api/ml/status`, method: 'GET', name: 'ML Status' },
        ];
        
        async function testEndpoint(endpoint) {
            const startTime = Date.now();
            try {
                const response = await fetch(endpoint.url, {
                    method: endpoint.method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const elapsed = Date.now() - startTime;
                const data = await response.text();
                
                return {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    elapsed: elapsed,
                    dataLength: data.length,
                    sample: data.substring(0, 200),
                    endpoint: endpoint
                };
            } catch (error) {
                return {
                    success: false,
                    status: 0,
                    statusText: error.message,
                    elapsed: Date.now() - startTime,
                    dataLength: 0,
                    sample: '',
                    endpoint: endpoint,
                    error: error.toString()
                };
            }
        }
        
        async function testAllEndpoints() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Testing endpoints...</p>';
            
            for (const endpoint of endpoints) {
                const result = await testEndpoint(endpoint);
                displayResult(result);
            }
            
            // Additional browser-specific test
            testBrowserSpecificIssues();
        }
        
        function displayResult(result) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${result.success ? 'success' : 'error'}`;
            
            let html = `
                <strong>${result.endpoint.name}</strong><br>
                <span class="endpoint">${result.endpoint.url}</span><br>
                Status: ${result.status} ${result.statusText}<br>
                Time: ${result.elapsed}ms | Size: ${result.dataLength} bytes
            `;
            
            if (!result.success && result.error) {
                html += `<br>Error: ${result.error}`;
            }
            
            if (result.success && result.sample) {
                html += `<br>Sample: <code>${result.sample.substring(0, 100)}...</code>`;
            }
            
            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }
        
        function testBrowserSpecificIssues() {
            const resultsDiv = document.getElementById('results');
            const browserDiv = document.createElement('div');
            browserDiv.className = 'test-result';
            browserDiv.style.background = '#3a3a3a';
            
            let html = '<h3>Browser Environment Info:</h3>';
            html += `User Agent: ${navigator.userAgent}<br>`;
            html += `Current URL: ${window.location.href}<br>`;
            html += `Protocol: ${window.location.protocol}<br>`;
            html += `Host: ${window.location.host}<br>`;
            
            // Check for CORS issues
            html += '<h4>CORS Test:</h4>';
            
            fetch(`${BACKEND_URL}/api/health`, { mode: 'cors' })
                .then(response => {
                    html += 'CORS: ✅ Enabled<br>';
                    browserDiv.innerHTML = html;
                })
                .catch(error => {
                    html += `CORS: ❌ Error - ${error}<br>`;
                    browserDiv.innerHTML = html;
                });
            
            resultsDiv.appendChild(browserDiv);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Test on page load
        window.addEventListener('load', () => {
            console.log('Backend Endpoint Tester loaded');
            console.log('Backend URL:', BACKEND_URL);
            console.log('ML Backend URL:', ML_BACKEND_URL);
        });
    </script>
</body>
</html>